\chapter{Hiện thực hệ thống} \label{hienthuchethong}
\section{Nội dung bài toán}
Bài toán mà chúng tôi giải quyết là bài toán: ``Phân giải đồng tham chiếu cho các hồ sơ xuất viện tiếng Anh với các khái niệm đã được trích xuất và gán nhãn''. Đầu vào của bài toán bao gồm hai phần:

\begin{enumerate}[leftmargin=\the\parindent]
\item \emph{Tập các hồ sơ xuất viện: }Đây là những văn bản lâm sàng được viết tay bằng ngôn ngữ tự nhiên bởi các bác sĩ, y tá. Chúng mô tả lại toàn bộ thông tin của bệnh nhân trong một lần điều trị, bao gồm các thông tin về tên bệnh mà bệnh nhân mắc phải, các thủ tục y tế được thực hiện và các phương pháp điều trị được áp dụng lên bệnh nhân. Để thuận tiện, từ đây trở đi chúng tôi dùng từ viết tắt HSXV để nói về các hồ sơ này.
\item \emph{Tập các khái niệm đã được trích xuất và gán nhãn:} Mỗi hồ sơ xuất viện đi kèm với một văn bản chứa toàn bộ các khái niệm được đề cập trong hồ sơ đó. Các khái niệm này đã được gán nhãn cho phù hợp với loại thực thể mà nó đề cập tới. Có tất cả năm nhãn là Problem, Treatment, Test, Person và Pronoun được i2b2 định nghĩa. Bảng \ref{tab:EntityLabels} mô tả chi tiết ý nghĩa của năm nhãn này.
\end{enumerate}

Mục tiêu của chúng tôi là phân giải đồng tham chiếu cho các khái niệm trong tập các khái niệm ứng với mỗi hồ sơ xuất viện. Cụ thể kết quả đầu ra là danh sách các chuỗi đồng tham chiếu của khái niệm đó, ví dụ \texttt{c="the patient" 13:0 13:1||c="he" 14:0 14:0||c="his" 14:7 14:7||t="coref person"} mô tả một chuỗi đồng tham chiếu bao gồm các khái niệm \texttt{"the patient"} (xuất hiện ở dòng thứ 13, từ vị trí 0 đến 1), \texttt{"he"} và \texttt{"his"}. Các khái niệm này đồng tham chiếu tới cùng một người (\texttt{t="coref person"}).

\begin{table}[th]
\centering\ra{1.3}
\caption{Ý nghĩa các lớp thực thể được đề xuất bởi i2b2\label{tab:EntityLabels}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}lLP{\colleft}{0.3}@{}}
\toprule
\textbf{Lớp} & \textbf{Định nghĩa} & \textbf{Ví dụ}\\
\midrule
\emph{Person} & Những chủ thể người hoặc một nhóm người được đề cập trong bệnh án và các đại từ nhân xưng & Dr.Lightman, the patient, cardiology, he, she, ...\\
\emph{Problem} & Những bất thường về sức khỏe thân thể hoặc tinh thần của bệnh nhân, được mô tả bởi bệnh nhân hoặc quan sát của bác sĩ & Heart attack, blood pressure, cancer, ...\\
\emph{Test} & Những thủ tục y tế như xét nghiệm, đo đạc, kiểm tra trên cơ thể bệnh nhân để cung cấp thêm thông tin cho ``Problem'' & CT scan, Temperature, ...\\
\emph{Treatment} & Những thủ tục y tế hoặc quy trình áp dụng để chữa trị cho ``Problem'', bao gồm thuốc, phẫu thuật hoặc phương pháp điều trị & Surgery, ice pack, Tylenol, ...\\
\emph{Pronoun} & Những đại từ có thể tham chiếu đến bất kì lớp nào trong bốn lớp kể trên nhưng không phải là đại từ nhân xưng & Which, it, that, ...\\
\bottomrule
\end{tabularx}
\end{table}

\section{Ý tưởng hiện thực\label{ytuonghienthuc}}
Dựa vào hệ thống có hiệu năng tốt nhất của thử thách i2b2 năm 2011 (hệ thống \cite{YanXu2012}), mô hình phân giải đồng tham chiếu mà chúng tôi sử dụng để hiện thực hệ thống là mô hình cặp thực thể. Tư tưởng cơ bản của mô hình này là xác định xem hai khái niệm bất kì có đồng tham chiếu với nhau hay không, sau đó gom nhóm các cặp đồng tham chiếu có một khái niệm chung lại để tạo thành các chuỗi đồng tham chiếu. Như vậy kiến trúc tổng quát của hệ thống chúng tôi hiện thực gồm hai quy trình: \emph{quy trình huấn luyện hệ thống phân loại} và \emph{quy trình phân giải đồng tham chiếu}. Trong đó quy trình huấn luyện là bước huấn luyện các model phân loại dựa trên dữ liệu mẫu đã được phân giải đồng tham chiếu. Quy trình phân giải sử dụng các model phân loại đã được huấn luyện để xác định tính đồng tham chiếu của các cặp khái niệm, từ đó sử dụng một giải thuật gom nhóm các cặp đồng tham chiếu lại để tạo thành các chuỗi đồng tham chiếu.

\subsection*{Quy trình huấn luyện}
Để xác định tính đồng tham chiếu giữa hai khái niệm bất kì, chúng tôi cần huấn luyện một mô hình phân loại dựa trên dữ liệu mẫu. Vì đầu vào của quy trình là các văn bản HSXV và danh sách các khái niệm đã được gán nhãn, hệ thống cần trích xuất đặc trưng của các dữ liệu thô này rồi mới có thể đưa vào để huấn luyện. Bên cạnh đó, các khái niệm đã được phân loại vào bốn nhóm chính là Person, Problem, Test và Treatment, còn các đại từ được phân vào nhóm Pronoun nên để giảm bớt số cặp khái niệm được sinh ra, chúng tôi huấn luyện bốn model để xác định tính đồng tham chiếu của riêng các cặp Person-Person, Problem-Problem, Test-Test và Treatment-Treatment (vì hai khái niệm thuộc hai lớp khác nhau thì nghiễm nhiên không đồng tham chiếu với nhau). Các đại từ đa phần chỉ tới các khái niệm ở trước đó, nên việc xác định xem một đại từ thực chất mang ý nghĩa của lớp nào trong bốn lớp chính Person, Problem, Test, Treatment là một việc quan trọng. Sau khi xác định được lớp chính của đại từ, chúng tôi chọn khái niệm thuộc lớp tương ứng ở gần nhất trước đó làm tiền đề cho nó. Các ý này đều là của các tác giả hệ thống \cite{YanXu2012}.

Ngoài ra cũng theo các tác giả này, thông tin một khái niệm lớp Person có chỉ về bệnh nhân hay không góp một phần quan trọng trong việc phân loại đúng tính đồng tham chiếu của các cặp khái niệm lớp này. Trong miền văn bản HSXV, các khái niệm chỉ người thường chỉ đề cập đến một trong ba loại: bệnh nhân, người thân của bệnh nhân và nhân sự của bệnh viện. Một BAĐT, mà cụ thể là một HSXV, thông thường chỉ đề cập đến một bệnh nhân nên những khái niệm nào chỉ về bệnh nhân thì chắc chắn nằm trong cùng chuỗi đồng tham chiếu lớn nhất và duy nhất chỉ về bệnh nhân đó. Từ nhận định này, nhóm tác giả của hệ thống \cite{YanXu2012} thêm vào đặc trưng lớp Patient (Patient-class) cho cặp hai khái niệm lớp Person, nó mang giá trị ``có'' khi hai khái niệm đều chỉ về bệnh nhân và ``không'' trong các trường hợp khác. Ở bước huấn luyện, thông tin ``một khái niệm Person có chỉ về bệnh nhân hay không'' được lấy từ tập chuỗi kết quả, còn ở bước phân giải đồng tham chiếu thông tin này được xác định nhờ một mô hình phân loại đã được huấn luyện.

Như vậy mục đích của quy trình huấn luyện là xây dựng tổng cộng sáu mô hình SVM, trong đó bốn mô hình SVM nhằm mục đích phân loại và đánh giá độ tin cậy đồng tham chiếu của các cặp khái niệm Person-Person, Problem-Problem, Test-Test và Treatment-Treatment; một mô hình SVM để xác định các khái niệm Person có là bệnh nhân hay không (Patient-class) và một mô hình SVM để phân loại các đại từ (các khái niệm lớp Pronoun) vào một trong bốn lớp Person, Problem, Test và Treatment. Đầu vào của quy trình này là toàn bộ các văn bản HSXV với các khái niệm đã được trích xuất và gán nhãn. Sau khi tiền xử lý, hệ thống xây dựng các mẫu huấn luyện bao gồm: Person, Person-Person, Problem-Problem, Test-Test, Treatment-Treatment và Pronoun từ danh sách các khái niệm. Sáu tập mẫu này được trích xuất thuộc tính và đưa vào để huấn luyện sáu mô hình SVM. 

Chúng tôi sử dụng thư viện LibSVM \cite{LibSVM2011} để huấn luyện các mô hình SVM với kernel bán kính cơ sở (RBF). Việc xác định các tham số đánh đổi $C$ và tham số kernel $\gamma$ cho mô hình được chúng tôi thực hiện bằng phương pháp tìm kiếm lưới trên miền $C\in\{2^{-5},2^{-3},\dots,2^{13},2^{15}\}$, $\gamma\in\{2^{-15},2^{-13},\dots,2^1,2^3\}$ và chọn ra cặp $(C,\gamma)$ cho kết quả kiểm chứng chéo 5 mẫu là cao nhất. Tuy nhiên đối với các tập đặc trưng của lớp Person, Treatment và Problem, do số vector đặc trưng nhiều và thời gian huấn luyện lâu nên bộ tham số mặc định \[C=1,\quad \gamma=\frac{1}{\text{số chiều vector}}\] được chúng tôi sử dụng để huấn luyện các mô hình này mà không thông qua tìm kiếm lưới. Sơ đồ trên Hình \ref{fig:SDHL} mô tả một cách trực quan toàn bộ quy trình huấn luyện nêu trên.

\begin{figure}[th]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.5cm and 2.3cm,
	every join/.style={->, draw},
	font=\scriptsize\sffamily]

	\node[multidoc](emr){HSXV};
	\node[multidoc, right=of emr, text width=3.5em](con){Danh sách khái niệm};
	\node[proc,below=1.3cm of $(emr)!0.5!(con)$](prep){Tiền xử lý};
	\node[io,join]{Các khái niệm/cặp khái niệm};
	\node[proc,join](ex){Rút trích đặc trưng};
	\node[io, right=3cm of con](perp){Đặc trưng cặp Person};
	\node[io](pati){Đặc trưng Person};
	\node[io](prop){Đặc trưng cặp Problem};
	\node[io](tstp){Đặc trưng cặp Test};
	\node[io](trep){Đặc trưng cặp Treatment};
	\node[io](pron){Đặc trưng Pronoun};	
	\node[proc, right=2.6cm of $(prop)!0.5!(tstp)$](train){Huấn luyện};
	\node[io,right=7cm of perp](perm){Mô hình SVM cặp Person};
	\node[io](patim){Mô hình SVM lớp Patient};
	\node[io](prom){Mô hình SVM cặp Problem};
	\node[io](tstm){Mô hình SVM cặp Test};
	\node[io](trem){Mô hình SVM cặp Treatment};
	\node[io](pronm){Mô hình SVM Pronoun};

	\draw[->] (emr) -- ++(down:0.9cm) -| (prep.130);
	\draw[->] (con) -- ++(down:0.9cm) -| (prep.50);
	\draw[->] (ex) -- ++(right:2.3cm) |- (perp);
	\draw[->] (ex) -- ++(right:2.3cm) |- (pati);
	\draw[->] (ex) -- ++(right:2.3cm) |- (prop);
	\draw[->] (ex) -- ++(right:2.3cm) |- (tstp);
	\draw[->] (ex) -- ++(right:2.3cm) |- (trep);
	\draw[->] (ex) -- ++(right:2.3cm) |- (pron);
	\draw[->] (perp) -- ++(right:1.8cm) |- (train);
	\draw[->] (pati) -- ++(right:1.8cm) |- (train);
	\draw[->] (prop) -- ++(right:1.8cm) |- (train);
	\draw[->] (tstp) -- ++(right:1.8cm) |- (train);
	\draw[->] (trep) -- ++(right:1.8cm) |- (train);
	\draw[->] (pron) -- ++(right:1.8cm) |- (train);
	\draw[->] (train) -- ++(right:1.5cm) |- (perm);
	\draw[->] (train) -- ++(right:1.5cm) |- (patim);
	\draw[->] (train) -- ++(right:1.5cm) |- (prom);
	\draw[->] (train) -- ++(right:1.5cm) |- (tstm);
	\draw[->] (train) -- ++(right:1.5cm) |- (trem);
	\draw[->] (train) -- ++(right:1.5cm) |- (pronm);	
\end{tikzpicture}
\caption{Sơ đồ huấn luyện\label{fig:SDHL}}
\end{figure}

\subsection*{Quy trình phân giải}
Quy trình phân giải đồng tham chiếu sử dụng sáu mô hình SVM đã được huấn luyện ở bước trên, cùng với đó là một giải thuật gom nhóm các cặp khái niệm đã được phân loại là đồng tham chiếu với nhau lại để cuối cùng tạo thành các chuỗi đồng tham chiếu. Có thể xem đây là quy trình mang đi ứng dụng thực tế để phân giải cho những văn bản HSXV mới. Dựa vào hệ thống \cite{YanXu2012}, chúng tôi sử dụng giải thuật gom cụm tốt nhất trước để lựa chọn các cặp đồng tham chiếu có độ tin cậy cao nhất, sau đó xây dựng các chuỗi đồng tham chiếu bằng cách nối các cặp có một khái niệm chung. Đối với lớp Pronoun, sau khi đã xác định được lớp chính của một đại từ bất kì, chúng tôi tạo một cặp đồng tham chiếu giữa đại từ đó và khái niệm thuộc lớp chính tương ứng ở gần nhất trước đó trong văn bản. Theo nhận định của các tác giả hệ thống \cite{YanXu2012}, tuy cách làm này đơn giản nhưng lại tỏ ra rất hiệu quả.

Hình \ref{fig:SDPG} mô tả trực quan quy trình phân giải đồng tham chiếu. Ở bước trích xuất thuộc tính của các cặp Person, chúng tôi sử dụng model phân loại bệnh nhân để xác định giá trị cho đặc trưng Patient-class. Theo kết quả đánh giá các hệ thống dự thi thử thách i2b2 2011, ba hệ đo được sử dụng để đánh giá hiệu năng là: MUC, B-CUBED và CEAF. Chúng tôi cũng hiện thực các hệ đo này để đánh giá các chuỗi đồng tham chiếu được xuất ra bởi hệ thống của mình và so sánh kết quả với hệ thống \cite{YanXu2012}. 

Ngoài ra Hình \ref{fig:DongKhaiNiem} mô tả các luồng khái niệm bắt đầu từ danh sách các khái niệm thô đến các chuỗi đồng tham chiếu, trong đó các khối \emph{Phân giải đồng tham chiếu lớp X} mang ý nghĩa trừu tượng về hệ thống phân giải đồng tham chiếu bao gồm các module rút trích đặc trưng, module phân loại và module gom cụm tương ứng cho lớp $X$.

\begin{figure}[th]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.7cm and 2.7cm,
	every join/.style={->, draw},
	font=\scriptsize\sffamily]

	\node[doc](emr){HSXV};
	\node[doc, right=of emr, text width=3.5em](con){Danh sách khái niệm};
	\node[proc, below=1.3cm of $(emr)!0.5!(con)$](prep){Tiền xử lý};
	\node[io,join](ins){Các khái niệm/cặp khái niệm};
	\node[proc,join](ex){Rút trích đặc trưng};
	\node[io, right=of ex, join](feat){Tập vector đặc trưng};
	\node[proc, right=of feat, join](clas){Phân loại};
	\node[multidoc, above=of clas, text width=3.5em](model){6 mô hình SVM};
	\node[io,below=of clas](conf){Độ tin cậy đồng tham chiếu};
	\node[proc,join,below=of ex](clus){Gom cụm};
	\node[io,join](sysc){Các chuỗi đồng tham chiếu};
	\node[proc,join,right=of sysc](eval){Đánh giá hiệu năng};
	\node[doc,right=of eval, text width=2cm](gt){Các chuỗi đồng tham chiếu kết quả (ground truth)};
	\node[io,below=of eval](res){Các số liệu độ đo};

	\draw[->] (emr) -- ++(down:0.9cm) -| (prep.130);
	\draw[->] (con) -- ++(down:0.9cm) -| (prep.50);
	\draw[->] (model) -> (clas);
	\draw[->] (clas) -> (conf);
	\draw[->] (ins) -- ++(left:1.8cm) |- (clus);
	\draw[->] (gt) -> (eval);
	\draw[->] (eval) -> (res);
	\draw[->] (model.200) -- ++(left:3cm) node[midway,above,sloped]{SVM Patient-class} -> (ex.north east);
\end{tikzpicture}
\caption{Sơ đồ phân giải đồng tham chiếu\label{fig:SDPG}}
\end{figure}

\begin{figure}[ht]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.5cm and 4cm,
	every join/.style={->, draw},
	font=\scriptsize\sffamily]
	\tikzset{
		wproc/.style = {proc, text width=5.2em},
		wdoc/.style = {doc, text width=3.7em}
	};
	
	\node[io](pati){Các khái niệm Person};
	\node[io](perp){Các cặp khái niệm Person};
	\node[io](prop){Các cặp khái niệm Problem};
	\node[io](tstp){Các cặp khái niệm Test};
	\node[io](trep){Các cặp khái niệm Treatment};
	\node[io](pron){Các khái niệm Pronoun};
	
	\node[wdoc,left=2.3cm of $(prop)!0.5!(tstp)$](emr){HSXV + DS khái niệm};
	\node[altproc,right=2.5cm of pati](patic){Phân loại bệnh nhân};
	\node[wproc,right=4.2cm of perp](perr){Phân giải đồng tham chiếu lớp Person};
	\node[wproc](pror){Phân giải đồng tham chiếu lớp Problem};
	\node[wproc](tstr){Phân giải đồng tham chiếu lớp Test};
	\node[wproc](trer){Phân giải đồng tham chiếu lớp Treatment};
	\node[wproc](pronr){Phân giải đồng tham chiếu lớp Pronoun};

	\node[io,right=5.2cm of perr](perch){Các chuỗi Person};
	\node[io](proch){Các chuỗi Problem};
	\node[io](tstch){Các chuỗi Test};
	\node[io](trech){Các chuỗi Treatment};
	
	\coordinate[left=0.5cm of perch.west](perch-left);
	\coordinate[left=1cm of proch.west](proch-left);
	\coordinate[left=1.5cm of tstch.west](tstch-left);
	\coordinate[left=2cm of trech.west](trech-left);
	
	\draw[->] (emr) -- ++(right:1.3cm) |- (pati);
	\draw[->] (emr) -- ++(right:1.3cm) |- (perp);
	\draw[->] (emr) -- ++(right:1.3cm) |- (prop);
	\draw[->] (emr) -- ++(right:1.3cm) |- (tstp);
	\draw[->] (emr) -- ++(right:1.3cm) |- (trep);
	\draw[->] (emr) -- ++(right:1.3cm) |- (pron);
	\draw[->] (pati) -> (patic);
	\draw[->] (patic) -| (perr);
	\draw[->] (perp) -> (perr);
	\draw[->] (prop) -> (pror);
	\draw[->] (tstp) -> (tstr);
	\draw[->] (trep) -> (trer);
	\draw[->] (pron) -> (pronr);
	\draw[->] (perr) -> (perch);
	\draw[->] (pror) -> (proch);
	\draw[->] (tstr) -> (tstch);
	\draw[->] (trer) -> (trech);
	\draw[->] (pronr) -| (perch-left);
	\draw[->] (pronr) -| (proch-left);
	\draw[->] (pronr) -| (tstch-left);
	\draw[->] (pronr) -| (trech-left);
\end{tikzpicture}
\caption{Các luồng khái niệm tạo thành chuỗi đồng tham chiếu \label{fig:DongKhaiNiem}}
\end{figure}

\section{Tiền xử lý}
Trong quá trình rút trích đặc trưng, một số khái niệm được miêu tả cụ thể làm cho việc so trùng chuỗi hoặc tìm kiếm từ các nguồn tri thức nhân loại thiếu chính xác \cite{YanXu2012}. Ví dụ như khái niệm \texttt{"her CT scan"} và khái niệm \texttt{"a CT scan"}, mặc dù hai khái niệm này cùng chỉ về một thủ tục y tế nhưng lại không trùng chuỗi. Ngoài ra các mạo từ \texttt{"her"} và \texttt{"a"} làm việc tìm kiếm từ các nguồn tri thức nhân loại như Wikipedia, WordNet không được chính xác hoặc không thể tìm được kết quả. Vì vậy, chúng tôi loại bỏ mạo từ xuất hiện trong các khái niệm trước khi thực hiện tìm kiếm. Ngoài ra giới từ và đoạn văn theo sau nó cũng được loại bỏ nếu có. Tuy nhiên, quá trình tiền xử lý chỉ được áp dụng cho các đặc trưng liên quan đến so trùng chuỗi và tìm kiếm tri thức nhân loại, các đặc trưng khác không bị ảnh hưởng bởi quá trình này.

Đặc biệt đối với các khái niệm thuộc lớp Problem/Treatment/Test, các thông tin về định lượng như \texttt{"10 mg"}, \texttt{"5 lit"} và các thông tin về vị trí giải phẫu học như \texttt{"upper"}, \texttt{"left"}, \texttt{"right"} thường xuất hiện trong chuỗi kí tự. Để tăng khả năng tìm kiếm tri thức nhân loại, chúng tôi đề xuất loại bỏ các thông tin ngữ cảnh như vậy khỏi khái niệm. Tổng kết lại quá trình tiền xử lý của hệ thống bao gồm hai tác vụ:

\begin{enumerate}
\item Trước khi tiến hành so trùng chuỗi, hệ thống loại bỏ các mạo từ và giới từ cùng với toàn bộ nội dung sau giới từ đó (nếu có). Danh sách mạo từ được chúng tôi xây dựng từ các mạo từ thông dụng trong tiếng Anh và qua việc khảo sát tập dữ liệu.
\item Trước khi tìm kiếm tri thức nhân loại cho các khái niệm thuộc lớp Problem, Test và Treatment, hệ thống loại bỏ các thông tin về số, định lượng và vị trí bằng cách sử dụng biểu thức chính quy và danh sách các từ vựng được xây dựng từ tập dữ liệu.
\end{enumerate}

Ví dụ hai khái niệm \texttt{"her CT scan"} và \texttt{"a CT scan"} sau quá trình tiền xử lý cả hai đều trở thành \texttt{"CT scan"}, hoặc khái niệm \texttt{"an MRI of the knee"} trở thành \texttt{"MRI"}.

\section{Xây dựng các cặp khái niệm}
Sau khi tiền xử lý, hệ thống xây dựng các cặp khái niệm với mục đích xác định xem hai khái niệm bất kì có đồng tham chiếu với nhau hay không. Vì SVM không có khả năng học tuần tự nên đối với \emph{quy trình huấn luyện}, chúng tôi cần xây dựng các cặp khái niệm từ toàn bộ danh sách khái niệm trong tập huấn luyện, sau đó rút trích đặc trưng cho toàn bộ các cặp khái niệm này và đưa vào huấn luyện các mô hình SVM. Một khó khăn của cách làm này là số cặp khái niệm phát sinh rất nhiều nếu tất cả các cặp được xây dựng cho một văn bản HSXV. Cụ thể với tập huấn luyện gồm 200 HSXV, mỗi hồ sơ chứa trung bình 150 khái niệm thì số các cặp khái niệm được sinh ra là $200\times \binom{150}{2}=2.235.000$ cặp. Dựa theo thực nghiệm của chúng tôi, sử dụng một tập vector đặc trưng chứa khoảng 300.000 vector để huấn luyện một mô hình SVM với kernel phi tuyến tính mất từ 4 đến 5 tiếng đồng hồ. Với một tập gồm hơn 2 triệu vector đặc trưng thì việc huấn luyện như vậy là bất khả thi.

Bên cạnh số lượng các vector đặc trưng, một vấn đề khác mà chúng tôi gặp phải trong quá trình huấn luyện là sự mất cân bằng trong phân bố lớp: các cặp không đồng tham chiếu (các mẫu âm) có số lượng quá nhiều so với các cặp đồng tham chiếu (các mẫu dương). Một tập vector đặc trưng bị mất cân bằng lớp sẽ khiến cho mô hình SVM được huấn luyện dựa trên tập đó có xu hướng phân loại về phía lớp có số lượng nhiều hơn. 

Để giải quyết vấn đề về số lượng cặp khái niệm, ở phần trước chúng tôi có nêu lên ý tưởng hiện thực là huấn luyện các mô hình SVM để phân loại tính đồng tham chiếu cho riêng các cặp Person-Person, Problem-Problem, Treatment-Treatment và Test-Test. Điều này không chỉ giúp cho các đặc trưng được rút trích chuyên biệt hơn cho mỗi loại cặp khái niệm, mà còn làm giảm đi số vector đặc trưng sinh ra để huấn luyện vì hệ thống chỉ xây dựng các cặp mà hai khái niệm có chung lớp chính.

Mặc dù cách làm trên giúp giảm bớt số lượng các mẫu huấn luyện, trong quá trình thực nghiệm, chúng tôi nhận thấy vấn đề về mất cân bằng mẫu vẫn xuất hiện ở các tập vector đặc trưng của các cặp Problem, Treatment và Test. Ở tập vector đặc trưng của cặp Test, số mẫu âm nhiều hơn số mẫu dương đến 381 lần. Vì vậy để giải quyết việc này, chúng tôi quyết định thử nghiệm với hai phương pháp chọn lọc mẫu sau:
\begin{enumerate}
\item Đối với mẫu dương, chỉ xây dựng các cặp đồng tham chiếu khi hai khái niệm nằm sát nhau theo thứ tự xuất hiện. Các mẫu âm được xây dựng giữa các khái niệm nằm giữa một cặp đồng tham chiếu và khái niệm đứng sau của cặp đó \cite{Soon2001}. Ví dụ Hình \ref{fig:insgen-eg} mô tả một đoạn văn bản và các chuỗi đồng tham chiếu của nó (giả định rằng tất cả các khái niệm ở ví dụ này thuộc cùng lớp). Có hai chuỗi đồng tham chiếu là $(C_1-C_2-C_3)$ và $(D_1-D_2)$, hai khái niệm $a$ và $b$ là duy nhất. Dựa theo phương pháp chọn lọc mẫu này, các mẫu dương bao gồm các cặp $(C_1,\,C_2)$, $(C_2,\,C_3)$ và $(D_1,\,D_2)$. Các mẫu âm bao gồm các cặp $(D_1,\,C_2)$, $(D_2,\,C_2)$, $(a,C_2)$ và $(b,C_2)$.

\begin{figure}[ht]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going right,
	node distance=1.5cm and 2cm,
	out=60, in=120,
	font=\sffamily]	
	\tikzset{
		con/.style={base, rectangle, inner sep=1mm, minimum height=0.8cm, minimum width=0.8cm},
		sgt/.style={base, circle, inner sep=1mm, minimum height=0.8cm}
	};

	\node[con](C1){$C_1$};
	\node[con](D1){$D_1$};
	\node[con](D2){$D_2$};
	\node[sgt](a){$a$};
	\node[sgt](b){$b$};
	\node[con](C2){$C_2$};
	\node[con](C3){$C_3$};
	
	\path[->, looseness=0.3] (C1.north) edge (C2.north);
	\path[->, looseness=0.7] (D1.north) edge (D2.north);
	\path[->, looseness=0.7] (C2.north) edge (C3.north);
	
\end{tikzpicture}
\caption{Ví dụ cho việc sinh các mẫu huấn luyện\label{fig:insgen-eg}}
\end{figure}

\item Phương pháp này xây dựng các mẫu huấn luyện theo các bước sau: với mỗi hồi chỉ $C_j$, xác định tiền đề của nó ở xa nhất theo thứ tự xuất hiện, gọi là $C_k$. Xây dựng các cặp với khái niệm đứng sau là $C_j$, khái niệm đứng trước là các khái niệm bắt đầu từ $C_k$ đến $C_{j-1}$ (chỉ xét những cặp hai khái niệm cùng lớp) \cite{VincentNg2002b}. Như vậy đối với ví dụ trên Hình \ref{fig:insgen-eg}, các mẫu  huấn luyện được sinh ra theo các bước của phương pháp này là: đối với $C_3$, tiền đề xa nhất của nó là $C_1$, như vậy các cặp $(C_1,\,C_3)$, $(D_1,\,C_3)$, $(D_2,\,C_3)$, $(a,\,C_3)$, $(b,\,C_3)$ và $(C_2,\,C_3)$ được xây dựng. Các khái niệm từ $C_2$ về $C_1$ được làm tương tự để xây dựng các mẫu huấn luyện còn lại.
\end{enumerate}

Trong quá trình thử nghiệm hai phương pháp chọn lọc mẫu trên, chúng tôi nhận thấy số lượng cặp khái niệm của mỗi loại giảm đi đáng kể khiến cho thời gian huấn luyện được cải thiện. Tuy nhiên kết quả đánh giá hiệu năng không được như mong đợi, cụ thể là độ đầy đủ tăng tên rất cao trong khi độ chính xác lại rất thấp. Điều này có thể được giải thích một cách chủ quan như sau:
\begin{itemize}
\item Đa phần các cặp đồng tham chiếu ở ba lớp Problem, Test và Treatment là các cặp có hai khái niệm đồng thuận về một tính chất nào đó dựa trên chuỗi kí tự biểu diễn.
\item Do có nhiều cặp không đồng tham chiếu (các mẫu âm) bị loại bỏ, các thông tin về việc phân lớp cho các trường hợp dạng này không được đưa vào để huấn luyện nên mô hình phân loại có xu hướng xác định đồng tham chiếu cho các cặp mà hai khái niệm có liên quan về chuỗi kí tự biểu diễn.
\end{itemize}

Ngoài ra, chúng tôi nhận thấy đa phần các mẫu âm quan trọng bị loại bỏ là các cặp gồm hai khái niệm duy nhất nhưng có liên quan về chuỗi kí tự biểu diễn. Vì vậy để cải thiện độ chính xác, chúng tôi quyết định sử dụng cách xây dựng mẫu thứ 2 và đưa thêm vào đó các cặp gồm hai khái niệm duy nhất mà có sự trùng lắp chuỗi con giữa chúng.

\section{Rút trích đặc trưng lớp Person và Pronoun}
Các lớp Person và Pronoun là các khái niệm tổng quát, có thể được bắt gặp trong nhiều lĩnh vực khác nhau không chỉ trong riêng lĩnh vực y tế và HSXV. Các khái niệm thuộc hai lớp này này có thể được xác định tính đồng tham chiếu nhờ vào các thuộc tính chung về mặt ngôn ngữ như ngữ pháp hay từ vựng. Đối với lớp Person, đầu vào của hệ thống rút trích đặc trưng là một cặp gồm hai khái niệm chỉ con người, tuy nhiên đầu vào của hệ thống rút trích đặc trưng lớp Pronoun chỉ là một khái niệm duy nhất thuộc lớp tương ứng.

\subsection*{Lớp Person}
\begin{table}[t!]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Person \label{tab:PersonFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}P{\raggedright}{0.3}lL@{}}
\toprule 
\textbf{Đặc Trưng} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
Patient-class & 0, 1, 2 & Không có khái niệm nào là bệnh nhân (0), cả hai khái niệm đều là bệnh nhân (1), trường hợp khác (2)\\
Distance between sentences & 0, 1, 2, 3, ... & Số câu xuất hiện giữa hai khái niệm được xét\\
Distance between mentions & 0, 1, 2, 3, ... & Số khái niệm xuất hiện giữa hai khái niệm được xét\\
String match & 0, 1 & Trùng chuỗi hoàn toàn (1), ngược lại (0)\\
Levenshtein distance between two mentions & 0, 1, 2, 3, ... & Khoảng cách Levenshtein giữa hai khái niệm\\
Number & 0, 1, 2 & Cả hai đều là số ít hoặc nhiều (1), ngược lại (0), không xác định (2)\\
Gender & 0, 1, 2 & Cùng giới tính (1), khác giới tính (0), không xác định (2)\\
Apposition & 0, 1 & Là đồng vị ngữ (1), ngược lại (0)\\
Alias & 0, 1 & Là từ viết tắt hoặc cùng nghĩa (1), ngược lại (0)\\
Who & 0, 1 & Nếu hai khái niệm liền kề nhau và được phân cách bởi dấu ``:''\\
Name match & 0, 1 & Loại bỏ các	``stop word'' (dr, dr., mr, ...), so trùng chuỗi con, trùng (1), không trùng (0)\\
Relative match & 0, 1 & Cả hai đều cùng chỉ đến một thân nhân (1), ngược lại (0)\\
Department match & 0, 1 & Cả hai cùng chỉ đến một lĩnh vực y học (1), ngược lại (0)\\
Doctor title match & 0, 1 & Cả hai có cùng một chức vụ bác sĩ (1), ngược lại (0)\\
Doctor general match & 0, 1 & Cả hai cùng đề cập đến bác sĩ nói chung (1), ngược lại (0)\\
Twin/triplet & 0, 1 & Cả hai đều chỉ về cùng cặp sinh đôi/sinh ba (1), ngược lại (0)\\
We & 0, 1 & Cả hai đều chứa thông tin về ``chúng tôi'' (1), ngược lại (0)\\
You & 0, 1 & Cả hai đều chứa thông tin về ``tôi'' (1), ngược lại (0)\\
I & 0, 1 & Cả hai đều chứa thông tin về ``bạn'' (1), ngược lại (0)\\
Pronoun match & 0, 1 & Cả hai đều là đại từ chỉ người (1), ngược lại (0)\\
\bottomrule
\end{tabularx}
\end{table}

Như đã đề cập trong phần \ref{ytuonghienthuc}, trong HSXV, các khái niệm thuộc lớp Person thường được chia vào ba nhóm chính: bệnh nhân, người thân của bệnh nhân hoặc nhân sự của bệnh viện. Trong đó bệnh nhân là nhóm có số lượng khái niệm được đề cập nhiều nhất và chiếm phần lớn tổng số khái niệm lớp Person. Do vậy việc xác định một khái niệm thuộc vào nhóm nào đóng vai trò quan trọng trong việc phân giải đúng các chuỗi đồng tham chiếu ở lớp Person \cite{YanXu2012}. 

Ở bước phân giải, đặc trưng Patient-class được xác định bằng cách sử dụng một mô hình SVM đã được huấn luyện. Ở bước huấn luyện, giá trị của đặc trưng này được xác định nhờ vào tập các chuỗi kết quả: nếu hai khái niệm chỉ người cùng nằm trong cùng chuỗi đồng tham chiếu chỉ về bệnh nhân, đặc trưng Patient-class của cặp hai khái niệm này sẽ mang giá trị là 1. Để xác định một chuỗi đồng tham chiếu bất kì có chỉ về bệnh nhân hay không, chúng tôi dựa vào một số đặc điểm như: thường là chuỗi chứa nhiều khái niệm nhất và các khái niệm trong chuỗi thường chứa các từ khóa về bệnh nhân như \texttt{"patient"} hay \texttt{"pt"}.

Bảng \ref{tab:PersonFeatures} trình bày đầy đủ các đặc trưng dùng cho lớp Person. Đặc trưng Alias được chúng tôi hiện thực bằng cách so trùng một khái niệm của cặp với từ viết tắt của khái niệm còn lại (nếu có). Cụ thể đầu tiên các kí tự bắt đầu của mỗi từ trong khái niệm được xem xét có viết hoa hay không, nếu có chúng tôi ghép các kí tự này lại để tạo thành từ viết tắt, sau đó so sánh từ viết tắt này với khái niệm còn lại của cặp, nếu trùng chuỗi thì đặc trưng Alias mang giá trị là 1, ngược lại là 0.

Đặc trưng về giới tính (đặc trưng Gender) mang ý nghĩa về sự đồng thuận về giới tính của hai khái niệm. Chúng tôi xác định giới tính của một khái niệm bằng các cách sau: đối với đại từ, giới tính của nó được xác định bằng ý nghĩa của chính nó, ví dụ như \texttt{"she"}, \texttt{"he"}. Đối với các tên riêng có chứa danh hiệu như \texttt{"Mr."}, \texttt{"Ms."} thì giới tính của khái niệm được xác định dựa trên giới tính của danh hiệu xưng hô đó. Trong trường hợp tên riêng không chứa danh hiệu, chúng tôi xem xét các khái niệm khác trong văn bản có cùng tên và xác định giới tính cho khái niệm đang xét qua danh hiệu của các khái niệm cùng tên này. Ví dụ khái niệm \texttt{"Peter H. Diller"} có thể xuất hiện nhiều lần, trong đó có xuất hiện dưới hình thức \texttt{"Mr. Diller"}. Nếu không thể xác định giới tính của tên riêng qua hai bước trên, các khái niệm này sẽ được phân loại bằng cách sử dụng cơ sở dữ liệu về tên tiếng Anh của hệ thống Apache OpenNLP. Trong trường hợp các bước kiểm tra này đều thất bại, khái niệm sẽ mang giới tính là ``không xác định''.

Các đặc trưng ``Name match'', ``Relative match'', ``Department match'', ``Doctor title match'', ``Doctor general match'', Twin/Triplet, We, You, I và ``Pronoun match'' được chúng tôi hiện thực bằng cách xây dựng tập từ điển tương ứng với từng đặc trưng dựa trên việc khảo sát tập dữ liệu và sử dụng các biểu thức chính quy. Các đặc trưng còn lại được chúng tôi hiện thực như miêu tả trong Bảng \ref{tab:PersonFeatures}.

\subsection*{Đặc trưng Patient-class}
\begin{table}[t!]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Patient \label{tab:PatientFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{\hspace{1em}}P{\raggedright}{0.3}lL@{}}
\toprule 
\rowgroup{\textbf{Đặc Trưng}} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
\rowgroup{\emph{Ngữ nghĩa}}\\
Keyword of patient & 0, 1 & Các từ khóa về bệnh nhân (như mr., mr, ms., ms, yo-, y.o., y/o, year-old, ...)\\
Keyword of doctor & 0, 1 & Các từ khóa về bác sĩ (dr, dr., md, m.d., m.d,…)\\
Keyword of doctor title & 0, 1 & Các từ khóa về chức vụ của bác sĩ (dentist, orthodontist, …)\\
Keyword of department  & 0, 1 & Các từ khóa về chuyên ngành bác sĩ (electrophysiology, …)\\
Keyword of general deparment & 0, 1 & Các từ khóa chung về phòng ban (team, service)\\
Keyword of general doctor & 0, 1 & Các từ khóa chung về bác sĩ (doctor, dict, author, pcp, attend, provider)\\
Keyword of relative & 0, 1 & Các từ khóa về người thân (wife, brother, sibling, nephew)\\
Name & 0, 1 & Có phải là tên riêng hay không\\
Last $n$ line doctor & 0, 1 & Là tên bác sĩ ở $n$ dòng cuối cùng\\
Twin or triplet information & 0, 1 & Thông tin về cặp sinh đôi, sinh ba (baby 1, 2, 3,…)\\
Preceded by non-patient & 0, 1 & Khái niệm đứng trước không phải là bệnh nhân.\\
Signed information  & 0, 1 & Có liên quan đến việc kí/xác nhận bệnh án\\
Previous sentence &  & Câu hoàn chỉnh liền trước khái niệm\\
Next sentence &  & Câu hoàn chỉnh liền sau khái niệm\\
\rowgroup{\emph{Ngữ pháp}}\\
Pronouns we & 0, 1 & Là đại từ chỉ chúng tôi (we, us, our, ourselves)\\
Pronouns I & 0, 1 & Là đại từ chỉ tôi (I, my, me, myself)\\
Pronouns you & 0, 1 & Là đại từ chỉ bạn (you, your, yourself)\\
Pronouns they & 0, 1 & Là đại từ chỉ họ (they, them, their, themselves)\\
Pronouns he/she most & 0, 1 & Thuộc phần đa số của đại từ chỉ cô ấy/anh ấy (he, his, her)\\
Who & 0, 1 & Là đại từ “who” hoặc liền kề với khái niệm đứng trước\\
Appositive & 0, 1 & Là đồng vị ngữ\\
\rowgroup{\emph{Từ vựng}}\\
\multicolumn{3}{l}{First three words before mention}\\
\multicolumn{3}{l}{First three words after mentiont}\\
\multicolumn{3}{l}{First three words in between mention, Problem}\\
\multicolumn{3}{l}{Last three words in between mention, Problem}\\
\multicolumn{3}{l}{First three words in between mention, Treatment}\\
\multicolumn{3}{l}{Last three words in between mention, Treatment}\\
\multicolumn{3}{l}{First three words in between mention, Test}\\
\multicolumn{3}{l}{Last three words in between mention, Test}\\
\bottomrule
\end{tabularx}
\end{table}

Đặc trưng Patient-class được rút trích cho từng khái niệm lớp Person nhằm huấn luyện một mô hình SVM để xác định các khái niệm này có chỉ về bệnh nhân hay không. Trong HSXV thường chỉ có một bệnh nhân đóng vai trò là chủ thể của bệnh án. Vì vậy, các khái niệm nếu được xác định là bệnh nhân thì sẽ được đưa vào cùng chuỗi đồng tham chiếu duy nhất chỉ về bệnh nhân đó. Thông qua phân tích tập dữ liệu, chúng tôi nhận thấy việc xác định một khái niệm lớp Person có chỉ về bệnh nhân hay không có thể dựa vào các từ khóa như \texttt{"patient"}, \texttt{"pt"}, hay những đại từ chỉ về bệnh nhân thường có cùng giới tính và chiếm số lượng lớn trong văn bản. Ngoài ra nếu khái niệm chứa các từ khóa như \texttt{"doctor"}, \texttt{"dr"} hay \texttt{"wife"} thì gần như chắc chắn không chỉ về bệnh nhân.

\begin{table}[t!]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Pronoun \label{tab:PronounFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{\hspace{1em}}P{\raggedright}{0.3}lL@{}}
\toprule 
\rowgroup{\textbf{Đặc Trưng}} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
\rowgroup{\emph{Quan hệ}}\\
First previous mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền trước thuộc lớp Person (0) hoặc Problem (1) hoặc Treatment (2) hoặc Test (3) hoặc không thuộc lớp nào (4)\\
Second previous mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền trước thứ 2 thuộc lớp Person (0) hoặc Problem (1) hoặc Treatment (2) hoặc Test (3) hoặc không thuộc lớp nào (4)\\
First next mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền sau thuộc lớp Person (0) hoặc Problem (1) hoặc Treatment (2) hoặc Test (3) hoặc không thuộc lớp nào (4)\\
\rowgroup{\emph{Khoảng cách}}\\
Sentence distance & 0, 1, 2, ... & Số câu xuất hiện giữa hai khái niệm được xét\\
\rowgroup{\emph{Ngữ pháp}}\\
Pronoun & 0, 1, 2, ..., 14 & Chỉ mục của đại từ được xét trong bảng tra 15 đại từ\\
\rowgroup{\emph{Cú pháp}}\\
Part of speech & 0, 1, 2 & DT (0), WDT (1), PRP (2)\\
First next verb after mention & & Động từ đứng liền sau khái niệm\\
First word before mention is preposition & 0, 1 & Từ liền trước là giới từ (1), ngược lại (0)\\
First one/two/three words before mention & & 1/2/3 từ liền trước khái niệm được xét\\
First one/two/three words after mention & & 1/2/3 từ liền sau khái niệm được xét\\
An adjacent mention after pronoun + VP  & 0, 1 & Khái niệm được xét liền sau đại từ + cụm động từ\\
\rowgroup{\emph{Ngữ nghĩa}}\\
And, as well as, in addition to & 0, 1 & Khái niệm được xét liền sau ``and'', ``as well as'', ``in addition to''\\
\bottomrule
\end{tabularx}
\end{table}

Để xác định một khái niệm có chỉ về bệnh nhân hay không trong quy trình huấn luyện, chúng tôi dựa vào tập các chuỗi kết quả như đã đề cập ở phần trước. Như vậy ở bước huấn luyện, các khái niệm thuộc chuỗi đồng tham chiếu chỉ về bệnh nhân được chọn làm mẫu dương, còn các khái niệm không thuộc vào chuỗi này được chọn làm mẫu âm. Bảng \ref{tab:PatientFeatures} trình bày đầy đủ các đặc trưng được sử dụng cho việc xác định khái niệm có phải là bệnh nhân hay không. Kết quả của việc phân loại này sẽ được sử dụng làm giá trị cho đặc trưng Patient-class khi rút trích đặc trưng cho lớp Person ở quy trình phân giải. Sau đây là chi tiết hiện thực cho một số đặc trưng trong Bảng \ref{tab:PatientFeatures}.

Đặc trưng ``Previous sentence'' và ``Next sentence'' được hiện thực bằng cách khảo sát toàn bộ các khái niệm thuộc lớp Person để xây dựng một bộ từ điển gồm các câu là tiêu đề phân đoạn (section heading) đứng ngay trước hoặc ngay sau mỗi khái niệm đó. Bộ từ điển này sau đó được sử dụng để xác định giá trị cho đặc trưng bằng cách lấy chỉ mục của câu đứng ngay trước đối khái niệm với đặc trưng ``Previous sentence'' hoặc đứng ngay sau khái niệm đối với đặc trưng ``Next sentence''. Mục đích của đặc trưng này là để giúp SVM rút ra được sự liên quan giữa các khái niệm chỉ người khi đứng gần với các đề mục, ví dụ những khái niệm chỉ về bác sĩ, y tá thì thường hay nằm gần đề mục nào.

Đặc trưng ``Pronouns he/she most'' được rút trích nhờ một đặc điểm mà chúng tôi đã nêu bên trên: các đại từ chỉ về bệnh nhân thường có cùng giới tính và chiếm đa số trong văn bản. Việc xác định nhóm ``he'' hay ``she'' chiếm đa số được chúng tôi hiện thực bằng cách đếm số các đại từ xuất hiện trong văn bản và chọn ra nhóm có số lượng khái niệm lớn hơn. Sau đó thông tin này được giữ lại để xác định giá trị cho đặc trưng ``Pronouns he/she most'': nếu trong HSXV nhóm ``he'' chiếm đa số thì những khái niệm là đại từ chỉ về giới tính nam như \texttt{"he"}, \texttt{"him"}, \texttt{"himself"} sẽ có đặc trưng này mang giá trị là 1. Tương tự nếu nhóm ``she'' chiếm đa số, các đại từ như \texttt{"she"}, \texttt{"her"} sẽ có đặc trưng này mang giá trị là 1.

Qua việc khảo sát tập dữ liệu, chúng tôi nhận thấy HSXV thường được kết thúc bằng các thông tin hướng dẫn liên lạc với bác sĩ nếu bệnh nhân gặp vấn đề sau khi xuất viện như thông tin về ngày tháng và mã hồ sơ, thông tin về các chỉ dẫn sau khi xuất viện và ký tên của bác sĩ. Để xác định phần HSXV chứa các thông tin này, chúng tôi khảo sát từng câu trong HSXV theo thứ tự từ dưới lên cho đến khi gặp các từ khóa như \texttt{"Follow-up"}, \texttt{"Dictated By"}, \texttt{"Signed By"}, v.v... Các đặc trưng ``Last n line doctor'' và ``Signed information'' được xác định từ các thông tin trong phần HSXV này.

Các đặc trưng thuộc nhóm từ vựng trên Bảng \ref{tab:PatientFeatures} như ``First three words before/after mention'' được chúng tôi thực hiện bằng cách xét toàn bộ tập huấn luyện và lưu lại các từ đứng xung quanh khái niệm đang xét, với bán kình là ba, thành một tập từ điển. Giá trị của mỗi đặc trưng thuộc nhóm từ vựng là một vector cho số chiều bằng tổng các từ khóa trong từ điển tương ứng, với thành phần thứ $i$ mang giá trị là 1 nếu từ thứ $i$ trong từ điển xuất hiện gần khái niệm đang xét. Ví dụ nếu tập từ điển ``ba từ đứng sau'' cho đặc trưng ``First three words after mention'' chứa 4 từ là $D=$ \{\texttt{"told"}, \texttt{"the"}, \texttt{"has"}, \texttt{"pain"}\} thì đặc trưng này được biểu diễn bằng một vector 4 chiều. Xét khái niệm \texttt{"the patient"} trong câu \texttt{"the patient has pain in the leg"}, dựa vào tập $D$ thì đặc trưng ``First three words after mention'' của khái niệm này có giá trị là (0, 0, 1, 1).

\subsection*{Lớp Pronoun}
Khác với các lớp khái niệm khác trong BAĐT, lớp khái niệm Pronoun là lớp khái niệm trừu tượng, có thể chỉ về bất kì khái niệm thuộc bốn lớp Person, Problem, Treatment, Test hoặc là khái niệm duy nhất. Để giải quyết vấn đề đồng tham chiếu cho lớp Pronoun, dựa vào hệ thống \cite{YanXu2012}, chúng tôi huấn luyện một mô mình SVM nhiều lớp (multi-class SVM). Mô hình SVM này được sử dụng để xác định các khái niệm thuộc lớp Pronoun thực chất mang ý nghĩa của lớp nào trong bốn lớp Person, Problem, Treatment, Test. Sau khi xác định được lớp ý nghĩa của đại từ, chúng tôi chọn khái niệm thuộc lớp tương ứng ở gần nhất trước đó để làm tiền đề cho nó. Ví dụ \texttt{"\underline{Hepatitis C cirrhosis} for \textsl{which} the patient was on the liver transplant list"} có \texttt{"which"} là đại từ cần xem xét và \texttt{"Hepatitis C cirrhosis"} là khái niệm thuộc lớp Problem. Nếu xác định được \texttt{"which"} thuộc lớp Problem, chúng tôi xem \texttt{"which"} và \texttt{"Hepatitis C cirrhosis"} là đồng tham chiếu do khái niệm \texttt{"Hepatitis C cirrhosis"} thuộc cùng lớp và ở gần nhất trước đó. Bảng \ref{tab:PronounFeatures} mô tả đầy đủ các đặc trưng được sử dụng cho lớp Pronoun. Sau đây là chi tiết hiện thực cho một số đặc trưng trong bảng.

Đặc trưng ``First next verb after mention'' và ``First one/two/three words before/after mention'' được chúng tôi hiện thực tương tự như các đặc trưng thuộc nhóm từ vựng trong Bảng \ref{tab:PatientFeatures}. Các đặc trưng ``Part of speech'', ``First word after mention is preposition'' và ``An adjacent mention after pronoun + VP'' của một đại từ được hiện thực bằng cách: đầu tiên xác định câu văn chứa đại từ đang xét trong HSXV, sau đó chúng tôi tiến hành tách từ và xác định từ loại cho các từ được tách trong câu đó. Dựa vào danh sách thông tin từ loại của đại từ và các từ xung quanh nó, các đặc trưng nêu trên được tính giá trị theo mô tả trên Bảng \ref{tab:PronounFeatures}.

\section{Rút trích đặc trưng lớp Problem, Treatment và Test}
Nhóm lớp Problem/Treatment/Test là nhóm lớp đặc biệt thuộc riêng lĩnh vực y khoa. Đa phần các khái niệm đồng tham chiếu trong các lớp này thường có chung chuỗi kí tự biểu diễn. Tuy nhiên trong nhiều trường hợp, mặc dù cùng một ý nghĩa nhưng các khái niệm lại được biểu diễn dưới nhiều hình thức khác nhau. Ví dụ trong HSXV, ``nồng độ bạch cầu trong máu'' có thể được biểu diễn bằng các cách: \texttt{"WBC"}, \texttt{"white blood cell count"} hoặc \texttt{"white blood count"}. Việc xác định các khái niệm được diễn đạt bằng các cách khác nhau nhưng có cùng một ý nghĩa có thể giúp tăng độ chính xác và giải quyết sai sót trong quá trình phân loại. Để làm được điều này, dựa theo hệ thống \cite{YanXu2012}, chúng tôi sử dụng các nguồn tri thức nhân loại (world knowledge) bên ngoài như Wikipedia, UMLS và WordNet.

\subsection*{Wikipedia}
Wikipedia là hệ thống bách khoa toàn thư miễn phí đa ngôn ngữ, nền Web, dựa trên mô hình cho phép người dùng chỉnh sửa nội dung. Các tri thức nhân loại từ Wikipedia có thể được sử dụng để xác định tên giả (alias), tên viết tắt, các từ đồng nghĩa hoặc có liên quan với nhau. Ví dụ hai khái niệm \texttt{"head trauma"} và \texttt{"head injury"} có thể được xác định là đồng nghĩa dựa trên thông tin từ Wikipedia.

Dựa trên thiết kế của hệ thống \cite{YanXu2012}, chúng tôi xây dựng bộ trích xuất các thông tin về tiêu đề bài viết (title hoặc redirected link), từ in đậm (bold name) và các khái niệm liên quan (anchor link) được đề cập trong bài viết. Ngôn ngữ của Wikipeda được chúng tôi sử dụng là tiếng Anh . Để trích xuất được các thông tin này, chúng tôi sử dụng công cụ Wikipedia-miner hỗ trợ khai thác thông tin từ Wikipedia dưới dạng dữ liệu cục bộ lưu trên máy. Do số lượng khái niệm cần được rút trích thông tin từ Wikipedia rất lớn, để cải thiện hiệu năng thời gian của hệ thống, trước khi thực hiện rút trích đặc trưng của nhóm lớp Problem/Treatment/Test, chúng tôi trích xuất trước thông tin từ Wikipedia cho các khái niệm thuộc nhóm lớp này và ghi xuống tập tin lưu trữ. Wikipedia được sử dụng cho các đặc trưng so trùng tiêu đề bài viết (Title match), so trùng từ in đậm (Bold name match) và so trùng khái niệm liên quan (Anchor link match) như miêu tả trong Bảng \ref{tab:ProbTreatTestFeatures}.

\subsection*{WordNet}
WordNet là bộ từ điển được xây dựng tiếng Anh bao gồm các từ vựng đã được phân loại vai trò ngữ pháp như danh từ, tính từ, trạng từ hay động từ. Các từ xuất hiện trong WordNet đã được nhóm lại với nhau thành các nhóm từ có cùng ý nghĩa. WordNet có vai trò giống như Wikipedia trong việc xác định tên giả, viết tắt và từ đồng nghĩa.

Cụ thể khi sử dụng công cụ WordNet, từ một khái niệm đầu vào, chúng tôi xác định được danh sách các từ đồng nghĩa (cognitive synonyms/synsets) với khái niệm đó kèm theo vai trò ngữ pháp của các từ đồng nghĩa. Danh sách các từ đồng nghĩa này được sử dụng cho đặc trưng ``WordNet match'' như miêu tả trong bảng (Bảng \ref{tab:ProbTreatTestFeatures}). Việc xác định sự đồng nghĩa của hai khái niệm được chúng tôi thực hiện bằng cách kiểm tra một khái niệm có tồn tại trong danh sách từ đồng nghĩa của khái niệm còn lại hay không.

\subsection*{UMLS}
Trong quá trình phát triển của y học, nhu cầu có một bộ từ điển chung, chứa các thông tin được chuẩn hóa về các loại bệnh, thuốc, nguyên nhân hoặc các thuật ngữ trong y tế ngày càng cao. Vì lí do đó, bộ từ điển UMLS - Unified Medical Language System đã được tiến hành xây dựng từ năm 1986 bởi Thư viện Y học Quốc gia Hoa Kì (US National Library of Medicine).

Dựa vào mô tả của hệ thống \cite{YanXu2012}, việc trích xuất một số đặc trưng về ngữ nghĩa trong văn bản cần sử dụng đến các thông tin trong bộ từ điển UMLS. Cụ thể bộ trích xuất ngữ nghĩa cần xác định phân nhóm của khái niệm nếu nó xuất hiện trong từ điển. Ví dụ như khái niệm ``lung cancer'' xuất hiện trong từ điển UMLS dưới phân nhóm Các tiến trình liên quan u, bướu (Neoplastic Process). Để trích xuất các thông tin này, chúng tôi sử dụng công cụ MetaMap được đề cập trong phần \ref{tools}. Tương tự như việc rút trích thông tin từ Wikipedia, chúng tôi rút trích thông tin từ UMLS cho các khái niệm và ghi xuống tập tin lưu trữ trên đĩa cứng trước khi tiến hành rút trích đặc trưng cho nhóm lớp Problem/Treatment/Test.

Một đặc điểm mà chúng tôi nhận thấy là đối với lớp Problem/Treatment/Test, có một số trường hợp một thực thể y khoa xuất hiện nhiều lần nhưng những lần đề cập đó lại không đồng tham chiếu với nhau. Nguyên nhân là vì các thực thể y khoa thường bị ảnh hưởng bởi ngữ cảnh thời gian và không gian mà chúng được đề cập đến. Ví dụ \texttt{"\textsl{pain} in the \underline{right leg}"} và \texttt{"\textsl{pain} in the \underline{left leg}"}, mặc dù hai khái niệm này đều chỉ về triệu chứng ``đau'', nhưng những ngữ cảnh trong văn bản cho thấy chúng không đồng tham chiếu với nhau, cụ thể là một khái niệm chỉ về đau ở chân phải còn khái niệm kia chỉ về đau ở chân trái. Vì vậy để xây dựng chính xác các chuỗi đồng tham chiếu cho nhóm lớp Problem/Treatment/Test, dựa theo hệ thống \cite{YanXu2012}, chúng tôi xây dựng các bộ trích xuất thông tin ngữ cảnh trong văn bản cho các khái niệm thuộc nhóm lớp này, với sự hỗ trợ của các thông tin được rút trích từ bộ từ điển UMLS. Sau đây chúng tôi trình bày chi tiết hiện thực của các bộ trích xuất thông tin ngữ cảnh.

\subsection*{Trích xuất thông tin cơ quan trên cơ thể (Anatomy)}
Trong HSXV, hai triệu chứng bệnh giống nhau có thể không đồng tham chiếu nếu chúng xuất hiện tại hai cơ quan cơ thể khác nhau. Ví dụ hai khái niệm \texttt{"\textsl{thrombosis} of the left subclavian vein"} và \texttt{"\textsl{thrombosis} of the left jugular vein"}, tuy cùng chỉ về chứng huyết khối (\texttt{"thrombosis"}) nhưng hai triệu chứng này lại xuất hiện tại hai cơ quan khác nhau là tĩnh mạch dưới đòn (\texttt{"subclavian vein"}) và tĩnh mạch cổ (\texttt{"jugular vein"}). Vì vậy dựa theo tập các chuỗi kết quả, hai khái niệm này là không đồng tham chiếu với nhau.

Để phân biệt các khái niệm như ví dụ trên, chúng tôi hiện thực bộ rút trích thông tin cơ quan trên cơ thể dựa trên bộ từ điển UMLS. Trong UMLS, các khái niệm được chia vào nhiều phân nhóm khác nhau dựa theo ý nghĩa của chúng. Cụ thể, chúng tôi sử dụng MetaMap để giới hạn việc nhận dạng các khái niệm chỉ thuộc vào các phân nhóm liên quan đến cơ thể như ``Anatomical Structure'', ``Body Location or Region'', ``Body Part, Organ, or Organ Component'', ``Body Space or Junction'' và ``Body System''. Sau khi nhận dạng được các thông tin cơ quan trên cơ thể, chúng tôi tiến hành so trùng chuỗi của các thông tin này để xác định hai khái niệm được đề cập trên cùng một cơ quan hay không.

\subsection*{Trích xuất thông tin vị trí (Position)}
Một số cơ quan trên cơ thể tuy giống nhau về mặt ngữ nghĩa nhưng lại chỉ phân biệt được bằng các tính từ chỉ vị trí đi kèm theo chúng. Ví dụ như \texttt{"\textsl{burning sensation} in the \underline{upper right leg}"} và \texttt{"\textsl{burning sensation} in the \underline{lower right leg}"}. Cùng một triệu chứng là cảm giác bỏng rát (burning sensation) ở chân phải (right leg), nhưng lại xuất hiện ở hai vị trí khác nhau là phía trên của chân (upper) và phía dưới của chân (lower). Vì vậy hai khái niệm này không đồng tham chiếu với nhau.

Từ việc khảo sát tập dữ liệu, chúng tôi xây dựng tập từ điển gồm các từ chỉ vị trí như \texttt{"left"}, \texttt{"right}, \texttt{"upper"}, \texttt{"lower"}, \texttt{"back"} hay \texttt{"front"}. Các thông tin vị trí được rút trích thông qua việc tìm kiếm sự xuất hiện của chúng trong tập từ điển. Tuy nhiên, chúng tôi nhận thấy rằng việc so trùng thông tin vị trí chỉ mang tính tương đối, vì một số khái niệm như \texttt{"left upper leg"} và \texttt{"left leg"} vẫn có thể đồng tham chiếu với nhau mặc dù vị trí trái trên (\texttt{"left upper"}) và trái (\texttt{"left"}) là khác nhau.

\subsection*{Trích xuất thông tin thuốc y tế (Medical information)}
Các thông tin về thuốc y tế là đặc trưng quan trọng đối với lớp Treatment. Thông tin về thuốc bao gồm tên thuốc (drug name, ví dụ như Morphine, Anti-biotic,...), đường hấp thụ (mode, ví dụ như qua đường miệng, tiêm,...), liều lượng (dosage, ví dụ như 10mg, 2 viên,...), tần số sử dụng (frequency, ví dụ như 2 lần một ngày, mỗi ngày,...) hay thời gian sử dụng (duration, ví dụ như 3 tuần, 1 tháng,...) có thể giúp phân giải đồng tham chiếu cho các khái niệm lớp Treatment. Ví dụ \texttt{"Modifinal 100 mg po qd"} có tên thuốc được đề cập là Modifinal, liều lượng là 100 mg, đường hấp thụ là uống qua miệng (\texttt{"po"}) và tần số sử dụng là 1 lần một ngày (\texttt{"qd"}). Nếu hai khái niệm chỉ thuốc chứa các thông tin liên quan có giá trị khác nhau thì chúng không đồng tham chiếu với nhau. Để rút trích thông tin thuốc y tế, chúng tôi sử dụng công cụ MedEx được đề cập trong mục \ref{tools}.

\subsection*{Trích xuất thông tin chỉ định của thủ tục y tế (Indicator)}
Một thủ tục y tế (khái niệm lớp Test) thường đi kèm với một hoặc một vài thông tin chỉ định mô tả chi tiết thủ tục đó, ví dụ nồng độ bạch cầu (WBC), nồng độ hồng cầu (RBC) hay nồng độ sắt trong máu (HCT). Hai khái niệm lớp Test chứa thông tin chỉ định khác nhau thì không đồng tham chiếu với nhau. Ví dụ khái niệm \texttt{"100 WBC"} và \texttt{"130 WBC"}, tuy cùng thông tin chỉ định là nồng độ bạch cầu trong máu, nhưng chúng lại có kết quả xét nghiệm khác nhau nên hai khái niệm này không đồng đám chiếu. Một ví dụ khác là \texttt{"100 WBC"} và \texttt{"100 RBC"}, tuy hai khái niệm có cùng kết quả xét nghiệm là 100 nhưng thông tin chỉ định lại khác nhau nên hai khái niệm này cũng không đồng tham chiếu. Như vậy cần thiết phải xác định rõ thông tin chỉ định cũng như giá trị kết quả khi phân giải đồng tham chiếu cho các khái niệm thuộc lớp Test.

Qua việc khảo sát tập dữ liệu, chúng tôi nhận thấy các thông tin chỉ định đa số là xác định nồng độ các hợp chất, tế bào, thành phần cơ thể, v.v... hay các giá trị đo lường. Để xác định các thông tin này, chúng tôi sử dụng MetaMap để nhận dạng khái niệm thuộc các phân nhóm liên quan như ``Quantitative Concept'', ``Pharmacologic Substance'' hay ``Element, Ion, or Isotope'', v.v... Sau khi xác định được thông tin chỉ định, chúng tôi kết hợp với biểu thức chính quy để tìm kết quả xét nghiệm.

\subsection*{Trích xuất thông tin thời gian (Temporal)}
Thông tin thời gian là một thông tin quan trọng trong phân giải đồng tham chiếu ở ba lớp Problem, Test và Treatment. Một thủ tục y tế được tiến hành ở hai thời điểm khác nhau thì không đồng tham chiếu hoặc cùng một loại thuốc nhưng được kê khai ở các thời điểm khác nhau thì độc lập. Thông tin thời gian được chia làm hai loại: thời gian tường minh, ví dụ 03/06/2015 hay thời gian suy diễn--các mốc thời gian được trích xuất từ một số từ khóa đứng gần khái niệm đang xét, ví dụ như ``Admission date'' (ngày nhập viện) hay ``Post-op day 2'' (ngày thứ 2 sau khi phẫu thuật).

Để trích xuất thông tin thời gian, chúng tôi thực hiện các bước sau: với mỗi khái niệm cần trích xuất, xác định câu văn chứa nó, sau đó sử dụng công cụ MedTime được đề cập trong mục \ref{tools} để nhận dạng thời gian xuất hiện trong câu. Khi đó thời gian của khái niệm được tính bằng giá trị thời gian nhận diện được. Ví dụ trong câu \texttt{"The patient's \textsl{right thigh hematoma} was performed on \underline{2010-06-28}"}, thời gian của khái niệm \texttt{"right thigh hentoma"} được xác định là \texttt{"2010-06-28"}. Nếu trong câu văn xuất hiện hai giá trị thời gian khác nhau thì chúng tôi sử dụng giá trị thời gian nằm gần khái niệm nhất. Ngoài ra, chúng tôi nhận thấy có một số thông tin thời gian được tách riêng và nằm trong một câu văn độc lập. Ví dụ trong trích đoạn HSXV trên Hình \ref{fig:eg-sep-time}, hai thủ tục y tế \texttt{"WBC"} và \texttt{"RBC"} xảy ra trong thời điểm được xác định là \texttt{"2014-04-23 7:56 AM"}, tuy nhiên giá trị thời gian này lại không nằm trên cùng câu văn với chúng. Để giải quyết vấn đề này, chúng tôi đề xuất nếu câu văn chứa khái niệm không có thông tin về thời gian, hệ thống sẽ xem xét 3 câu văn liền trước để cố gắng tìm kiếm thông tin thời gian liên quan.

\begin{figure}[ht]
\centering
\begin{lstlisting}[%
	keepspaces=true,
	xleftmargin=.3\textwidth,
	xrightmargin=.3\textwidth,
	basicstyle=\ttfamily]
(*@\underline{2014-04-23 07:56 AM}@*)
(*@\textit{WBC}@*) - 9.4
(*@\textit{RBC}@*) - 4.75
\end{lstlisting}
\caption{Ví dụ thông tin thời gian nằm trên một câu văn khác\label{fig:eg-sep-time}}
\end{figure}

\subsection*{Trích xuất thông tin phân đoạn bệnh án (Section)}
Một hồ sơ xuất viện thường được chia làm các phân đoạn (section) như: tiền sử bệnh, tiền sử dùng thuốc hay tiền sử nhập viện. Hai khái niệm xuất hiện ở hai phần khác nhau thì thường không đồng tham chiếu với nhau cho dù chúng có cùng cách viết. Ví dụ nếu cụm \texttt{"CT scan"} cùng xuất hiện ở phần lịch sử bệnh và phần xét nghiệm thể chất thì hai khái niệm \texttt{"CT scan"} này là độc lập với nhau. Một số tên phân đoạn phổ biến là xét nghiệm thể chất (physical examination), lịch sử bệnh (history of present illness), tiền sử thuốc (past medical history), dị ứng và kháng thuốc (allergies and adverse reactions), ...

Mỗi HSXV thường được viết dựa trên cấu trúc của từng khoa trong bệnh viện. Tùy vào chức năng, đặc trưng của từng khoa mà HSXV của các khoa khác nhau sẽ bao gồm các phân đoạn khác nhau. Vì vậy, các phân đoạn trong HSXV rất đa dạng và không có sẵn đầy đủ. Để chọn ra danh sách tên các phân đoạn có trong HSXV, chúng tôi dựa trên một số luật được rút ra từ việc khảo sát tập dữ liệu theo công trình ở \cite{RandolphMiller2008}, bao gồm: các đầu mục phải kết thúc bằng dấu hai chấm (:), các tên phân đoạn thường được viết hoa toàn bộ hoặc viết hoa các chữ cái đầu tiên. Từ các luật được này, chúng tôi tạo danh sách toàn bộ các câu có khả năng là tên của phân đoạn trong HSXV, sau đó chọn ra 15 tên phân đoạn có tần suất xuất hiện cao nhất.

\subsection*{Trích xuất thông tin bổ từ (Modifier)}
Tính đồng tham chiếu của một số khái niệm thuộc lớp Test có thể được xác định bởi các từ bổ nghĩa đi kèm theo chúng, ví dụ các từ như \texttt{"recent"}, \texttt{"prior"} hay \texttt{"initial"}. Tập từ khóa của thông tin bổ từ được chúng tôi xây dựng thông qua việc khảo sát tập dữ liệu.

\subsection*{Trích xuất thông tin thiết bị y tế (Equipment)}
Thiết bị y tế được sử dụng cũng là một gợi ý ngữ nghĩa cho việc xác định phân giải đồng tham chiếu cho các khái niệm chỉ về thủ tục ý tế. Lí do là vì các thủ tục y tế thường được đặt tên theo thiết bị sử dụng. Như vậy nếu hai thủ tục y tế sử dụng hai thiết bị khác nhau thì không đồng tham chiếu với nhau. 

Để hiện thực đặc trưng này, đầu tiên chúng tôi sử dụng MetaMap để kiểm tra sự xuất hiện của khái niệm trong UMLS, sau đó xét xem nó có là một thủ tục y tế hay không bằng các hậu tố \texttt{"-graphy"}, \texttt{"-gram"}, \texttt{"-metry"} hay \texttt{"-scopy"}. Nếu khái niệm xuất hiện trong UMLS và có phần hậu tố như vậy thì nó được xác định là một thiết bị y tế.

\subsection*{Trích xuất thông tin phẫu thuật y tế (Operation)}
Phần lớn các khái niệm thuộc lớp Treatment được đề cập là các phẫu thuật y tế. Vì vậy đặc trưng thông tin phẫu thuật y tế có thể xem là một gợi ý cho việc phân giải đồng tham chiếu lớp Treatment. Các phẫu thuật y tế được xác định bằng cách: khái niệm có tồn tại trong bộ từ điển UMLS và kết thúc bằng các hậu tố ngữ \texttt{"-tomy"} hay \texttt{"-plasty"}.

Mặc dù có nhiều ngữ cảnh cho các thông tin về chuyên ngành y tế, không phải đặc trưng ngữ cảnh nào cũng có nghĩa cho tất cả ba lớp Problem, Treatmant và Test. Ví dụ đặc trưng về thuốc y tế chỉ có ý nghĩa khi được sử dụng cho lớp Treatment mà không phải cho lớp Problem hoặc Test. Bảng \ref{tab:SemanticFeatures} trình bày việc phân chia các đặc trưng ngữ nghĩa được sử dụng cho từng lớp khái niệm. Bảng \ref{tab:ProbTreatTestFeatures} liệt kê đầy đủ các đặc trưng được chúng tôi sử dụng trong việc huấn luyện mô hình SVM cho nhóm lớp Problem/Treatment/Test, trong đó đầu vào của hệ thống rút trích đặc trưng là một cặp hai khái niệm thuộc lớp tương ứng.

\begin{table}[ht]
\centering\ra{1.2}
\caption{Phân chia các đặc trưng ngữ nghĩa được sử dụng ở ba lớp Problem, Treatment và Test \label{tab:SemanticFeatures}}
\footnotesize\sffamily

\begin{tabularx}{0.7\textwidth}{@{}l *5{>{\centering\arraybackslash}X}@{}}
\toprule 
& \textbf{Problem} & \textbf{Treatment} & \textbf{Test}\\
\midrule
Anatomy & + & & +\\
Position & + & + & +\\
Medication & & + & \\
Indicator & & & +\\
Temporal & & + & +\\
Section & + & + & +\\
Modifier & & & +\\
Equipment & & & +\\
Operation & & + & \\
\bottomrule
\end{tabularx}
\end{table}

\section{Gom cụm và xây dựng chuỗi đồng tham chiếu}
Ở mô hình cặp thực thể, hệ thống phân loại không có khả năng xây dựng chuỗi đồng tham chiếu mà nó chỉ có thể xác định một cặp khái niệm là có đồng tham chiếu hay không. Mặt khác, đối với một văn bản HSXV, số cặp khái niệm được sinh ra rất nhiều và trong số đó có nhiều cặp có chung khái niệm đứng sau, ví dụ hai cặp (\texttt{"Dr. John"}, \texttt{"his"}) và (\texttt{"Mr. Brown"}, \texttt{"his"}) có chung khái niệm đứng sau là \texttt{"his"} mà hai cặp này đều được hệ thống phân loại xác định là đồng tham chiếu, tuy nhiên chỉ một trong hai khái niệm \texttt{"Dr. John"} hoặc \texttt{"Mr. Brown"} được chọn làm tiền đề cho khái niệm \texttt{"his"} này. Như vậy cần thiết phải có một giải thuật lựa chọn các cặp đồng tham chiếu và xây dựng các chuỗi đồng tham chiếu từ chúng.

Như đã được đề cập ở mục \ref{coref-model}, có hai giải thuật được đề xuất là: \emph{gom cụm gần nhất trước} và \emph{gom cụm tốt nhất trước}. Chúng tôi lựa chọn thực hiện giải thuật gom cụm tốt nhất trước cho hệ thống của mình vì hai lý do:
\begin{enumerate}
\item Theo các tác giả của giải thuật, giải thuật gom cụm tốt nhất trước cho kết quả tốt hơn giải thuật gom cụm gần nhất trước \cite{VincentNg2002a}.
\item Các tác giả hệ thống \cite{YanXu2012} cũng hiện thực giải thuật này cho hệ thống của họ.
\end{enumerate}

Về cơ bản, giải thuật gom cụm tốt nhất trước lựa chọn các cặp khái niệm được xác định là đồng tham chiếu và có độ tin cậy cao nhất ứng với mỗi hồi chỉ; đối với đại từ, giải thuật sử dụng module phân loại xác định lớp chính của đại từ đó và tạo một cặp đồng tham chiếu giữa nó với khái niệm thuộc lớp tương ứng gần nhất trước đó (theo thứ tự xuất hiện) trong văn bản HSXV. Sau khi có được tập các cặp đồng tham chiếu, giải thuật nối các cặp có một khái niệm chung lại để tạo thành các chuỗi. Đây chính là kết quả cuối cùng của hệ thống phân giải.

Như vậy giải thuật gom cụm cụm tốt nhất trước bao gồm hai bước chính: chọn lọc các cặp đồng tham chiếu tốt nhất và ghép nối các cặp được chọn để tạo thành danh sách các chuỗi đồng tham chiếu. Bước đầu tiên làm việc như sau:
\begin{enumerate}
\item Nhận đầu vào là văn bản $E$ và danh sách các khái niệm $C$ được sắp xếp theo thứ tự xuất hiện. Gọi $M$ là số khái niệm trong $C$. $P$ là danh sách các cặp khái niệm, khởi tạo $P=\emptyset$.
\item Duyệt toàn bộ danh sách $C$ từ đầu đến cuối theo thứ tự xuất hiện ($j=1\rightarrow M$), với mỗi khái niệm $C_j$, nếu $C_j$ thuộc một trong 4 lớp Person, Problem, Test hoặc Treatment thì tới bước 3, nếu $C_j$ thuộc lớp Pronoun thì tới bước 4. Nếu đã duyệt xong, đi tới bước 6.
\item Với mỗi cặp $(C_i,\,C_j)$ mà $C_i$ đứng trước $C_j$ ($i<j$), chọn ra cặp $(C_k,\,C_j)$ mà hệ thống phân loại xác định là đồng tham chiếu và có độ tin cậy cao nhất, đưa cặp $(C_k,\,C_j)$ tới bước 5.
\item Sử dụng hệ thống phân loại xác định lớp chính $T$ của $C_j$. Duyệt từ khái niệm ngay trước $C_j$ về đầu ($i=j-1\rightarrow 1$), nếu $C_i$ thuộc lớp $T$, ngừng duyệt và đưa cặp $(C_i,\,C_j$) tới bước 5.
\item Nhận cặp $(C_i,\,C_j)$ được chọn ở một trong hai bước trên, đưa cặp vào $P$ và quay trở lại bước 2.
\item Trả $P$ về làm kết quả.
\end{enumerate} 

Sau khi đã có được danh sách các cặp đồng tham chiếu tốt nhất từ bước trên, hệ thống ghép nối các cặp trong danh sách lại để tạo thành các chuỗi đồng tham chiếu:
\begin{enumerate}
\item Nhận đầu vào là danh sách cặp khái niệm $P$.
\item Khởi tạo danh sách chuỗi $H=\emptyset$.
\item Với mỗi cặp $(C_i,\,C_j)$ trong $P$, duyệt tất cả các chuỗi $K$ trong $H$, nếu tìm được một chuỗi $K^{\prime}$ mà chứa một trong hai khái niệm $C_i$ hoặc $C_j$ của cặp thì đưa $C_i$, $C_j$ vào $K^{\prime}$ và quay lại bước 3. Nếu không tìm được chuỗi nào thỏa điều kiện trên, đưa cặp $(C_i,\,C_j)$ tới bước 4. Nếu đã duyệt xong, tới bước 5.
\item Khởi tạo một chuỗi $K^{\prime}$ mới gồm hai khái niệm của cặp, $K^{\prime}=\{C_i,\,C_j\}$, đưa chuỗi vào $H$ và quay lại bước 3.
\item Trả $H$ về làm kết quả.
\end{enumerate}

\begin{table}[th]
\centering
\caption{Tập đặc trưng cho ba lớp Problem, Treatment và Test \label{tab:ProbTreatTestFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}>{\hspace{1em}}P{\raggedright}{0.3}lL@{}}
\toprule 
\rowgroup{\textbf{Đặc Trưng}} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
\rowgroup{\textit{Tri thức nhân loại}}\\
Wiki page match & 0, 1 & Hai khái niệm cùng dẫn đến một trang Wiki\\
Wiki anchor match & 0, 1 & Trang Wiki của một khái niệm chứa liên kết đến trang wiki của khái niệm còn lại\\
Wiki bold name match & 0, 1 & Trang Wiki của một khái niệm chứa từ in đậm chỉ khái niệm còn lại\\
WordNet match & 0, 1 & Hai khái niệm được xác định đồng nghĩa trên WordNet\\
\rowgroup{\textit{Trích xuất thông tin ngữ nghĩa trong văn bản}}\\
Anatomy & 0, 1, 2 & Không cùng cơ quan cơ thể (0), cùng cơ quan (1), không xác định (2)\\
Position & 0, 1, 2 & Không cùng vị trí (0), cùng vị trí (1), không xác định (2)\\
Indicator & 0, 1, 2 & Không cùng thông tin chỉ định (0), cùng thông tin chỉ định (1), không xác định (2)\\
Temporal & 0, 1, 2 & Không cùng thời gian (0), cùng thời gian (1), không xác định (2)\\
Section & 1, 2,..., $n^{2}$ & Hai khái niệm thuộc về phân đoạn i và j của văn bản\\
Equipment & 0, 1, 2 & Không cùng thiết bị (0), cùng thiết bị (1), không xác định (2)\\
Operation & 0, 1, 2 & Không cùng phẫu thuật (0), cùng phẫu thuật (1), không xác định (2)\\
\rowgroup{\textit{Trích xuất thông tin thuốc y tế}}\\
Drug & 0, 1 & Cùng tên thuốc (1), ngược lại (0)\\
Mode & 0, 1, 2,..., 29 & Chỉ mục của 29 đường hấp thụ hoặc không xác định (29)\\
Dosage & 0, 1 & Cùng liều lượng (1), ngược lại (1)\\
Duration & 0, 1 & Cùng khoảng thời gian sử dụng (1), ngược lại (0)\\
Frequency & 0, 1 & Cùng tần suất sử dụng (1), ngược lại (0)\\
\textit{Khoảng cách}\\
Sentence distance & 0, 1, 2,... & Số câu xuất hiện giữa hai khái niệm được xét\\
\rowgroup{\textit{Ngữ pháp}}\\
Article & 1, 2,..., $3^{2}$ & Trạng thái các từ hạn định (determiner) đứng trước hai khái niệm, bao gồm 3 loại: (a|an), (the|his|her…) hoặc không có (NULL)\\
\rowgroup{\textit{So trùng chuỗi}}\\
Head noun match & 0, 1 & Cùng danh từ trung tâm (1), ngược lại (0)\\
Contains & 0, 1 & Một khái niệm chứa toàn bộ chuỗi của khái niệm còn lại\\
Capital match & 0, 1 & Các kí tự đầu tiên trùng nhau (1), ngược lại (0)\\
Substring match & 0, 1 & Có cùng chuỗi con (1), ngược lại (0)\\
Cos distance & (0, 1) & Khoảng cách cos (góc) giữa hai khái niệm\\
\rowgroup{\textit{Ngữ nghĩa}}\\
Word match & 0, 1 & Hai khái niệm trùng chuỗi hoàn toàn\\
Procedure match & 0, 1 & Có chứa từ ``Procedure'' (1), ngược lại (0)\\
\bottomrule
\end{tabularx}
\end{table}
