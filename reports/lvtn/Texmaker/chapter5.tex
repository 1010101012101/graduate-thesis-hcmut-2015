\chapter{Hiện thực hệ thống}
\section{Nội dung bài toán}
Bài toán mà chúng tôi giải quyết là bài toán: ``Phân giải đồng tham chiếu cho các hồ sơ xuất viện tiếng Anh với các khái niệm đã được trích xuất và gán nhãn''. Đầu vào của bài toán bao gồm hai phần:

\begin{enumerate}[leftmargin=\the\parindent]
\item \emph{Tập các hồ sơ xuất viện: }Đây là những văn bản lâm
sàng được viết tay bằng ngôn ngữ tự nhiên bởi các bác sĩ, y tá. Chúng
mô tả lại toàn bộ thông tin của bệnh nhân trong một lần điều trị,
bao gồm các thông tin về tên bệnh mà bệnh nhân mắc phải, các thủ tục
y tế được thực hiện và các phương pháp điều trị được áp dụng lên bệnh
nhân.
\item \emph{Tập các khái niệm đã được trích xuất và gán nhãn:}
Mỗi hồ sơ xuất viện đi kèm với một văn bản chứa toàn bộ các khái niệm
được đề cập trong hồ sơ đó. Các khái niệm này đã được gán nhãn cho
phù hợp với loại thực thể mà nó đề cập tới. Có tất cả năm nhãn là
Problem, Treatment, Test, Person và Pronoun được i2b2 định nghĩa.
Bảng \ref{tab:EntityLabels} mô tả chi tiết ý nghĩa của năm nhãn này.
\end{enumerate}

Mục tiêu của chúng tôi là phân giải đồng tham chiếu cho các khái niệm trong tập các khái niệm ứng với mỗi hồ sơ xuất viện. Cụ thể kết quả đầu ra là danh sách các chuỗi đồng tham chiếu của khái niệm đó, ví dụ \emph{c=``the patient'' 13:0 13:1||c=``he'' 14:0 14:0||c=``his'' 14:7 14:7||t=``coref person''} mô tả một chuỗi đồng tham chiếu bao gồm các khái niệm ``the patient'' (xuất hiện ở dòng thứ 13, từ vị trí 0 đến 1), ``he'' và ``his''. Các khái niệm này đồng tham chiếu tới cùng một người (\emph{t=``coref person''}).

\begin{table}[th]
\centering\ra{1.3}
\caption{Ý nghĩa các lớp thực thể được đề xuất bởi i2b2\label{tab:EntityLabels}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}lLP{\raggedright}{0.3}@{}}
\toprule
\textbf{Lớp} & \textbf{Định nghĩa} & \textbf{Ví dụ}\\
\midrule
\emph{Person} & Những chủ thể người hoặc một nhóm người được đề cập trong bệnh án và các đại từ nhân xưng & Dr.Lightman, the patient, cardiology, he, she, ...\\
\emph{Problem} & Những bất thường về sức khỏe thân thể hoặc tinh thần của bệnh nhân, được mô tả bởi bệnh nhân hoặc quan sát của bác sĩ & Heart attack, blood pressure, cancer, ...\\
\emph{Test} & Những thủ tục y tế như xét nghiệm, đo đạc, kiểm tra trên cơ thể bệnh nhân để cung cấp thêm thông tin cho “Problem” & CT scan, Temperature, ...\\
\emph{Treatment} & Những thủ tục y tế hoặc quy trình áp dụng để chữa trị cho "Problem", bao gồm thuốc, phẫu thuật hoặc phương pháp điều trị & Surgery, ice pack, Tylenol, ...\\
\emph{Pronoun} & Những đại từ có thể tham chiếu đến bất kì lớp nào trong bốn lớp kể trên nhưng không phải là đại từ nhân xưng & Which, it, that, ...\\
\bottomrule
\end{tabularx}
\end{table}

\section{Ý tưởng hiện thực} \label{ytuonghienthuc}
Dựa vào hệ thống có hiệu năng tốt nhất của thử thách i2b2 năm 2011 (hệ thống I), mô hình phân giải đồng tham chiếu mà chúng tôi sử dụng để hiện thực hệ thống là mô hình cặp thực thể. Tư tưởng cơ bản của mô hình này là xác định xem hai khái niệm bất kì có đồng tham chiếu với nhau hay không, sau đó gom nhóm các cặp đồng tham chiếu có một khái niệm chung lại để tạo thành các chuỗi đồng tham chiếu. Như vậy kiến trúc tổng quát của hệ thống chúng tôi hiện thực gồm 2 quy trình: \emph{quy trình huấn luyện hệ thống phân loại} và \emph{quy trình phân giải đồng tham chiếu}. Trong đó quy trình huấn luyện là bước huấn luyện các model phân loại dựa trên dữ liệu mẫu đã được phân giải đồng tham chiếu. Quy trình phân giải sử dụng các model phân loại đã được huấn luyện để xác định tính đồng tham chiếu của các cặp khái niệm, từ đó sử dụng một giải thuật gom nhóm các cặp đồng tham chiếu lại để tạo thành các chuỗi đồng tham chiếu.

\subsection*{Quy trình huấn luyện}
Để xác định tính đồng tham chiếu giữa hai khái niệm bất kì, ta cần huấn luyện một model phân loại dựa trên dữ liệu mẫu. Vì đầu vào của quy trình là các văn bản BAĐT và danh sách các khái niệm đã được gán nhãn, hệ thống cần trích xuất đặc trưng của các dữ liệu thô này rồi mới có thể đưa vào để huấn luyện. Bên cạnh đó, các khái niệm đã được phân loại vào 4 nhóm chính là Person, Problem, Test và Treatment, còn các đại từ được phân vào nhóm Pronoun nên để giảm bớt số cặp khái niệm được sinh ra, chúng tôi huấn luyện 4 model để xác định tính đồng tham chiếu của riêng các cặp Person-Person, Problem-Problem, Test-Test và Treatment-Treatment (vì hai khái niệm thuộc hai lớp khác nhau thì nghiễm nhiên không đồng tham chiếu với nhau). Đối với các đại từ thì thường chỉ tới một khái niệm ở trước đó, nên việc xác định xem một đại từ thực chất mang ý nghĩa của lớp nào trong 4 lớp chính Person, Problem, Test, Treatment là một việc quan trọng. Sau khi xác định được lớp chính của đại từ, chúng tôi chọn khái niệm thuộc lớp tương ứng ở gần nhất trước đó làm tiền đề cho nó. Các ý này đều là của các tác giả hệ thống I.

Ngoài ra cũng theo các tác giả này, thông tin một khái niệm lớp Person có chỉ về bệnh nhân hay không góp một phần quan trọng trong việc phân loại đúng tính đồng tham chiếu của cặp các khái niệm lớp này. Trong miền văn bản BAĐT, các khái niệm chỉ người thường chỉ đề cập đến một trong ba loại: bệnh nhân, người thân của bệnh nhân và nhân sự của bệnh viện. Do một BAĐT, mà cụ thể là hồ sơ xuất viện, thông thường chỉ đề cập đến một bệnh nhân nên những khái niệm nào chỉ về bệnh nhân thì thường chắc chắn nằm trong cùng một chuỗi đồng tham chiếu lớn nhất và duy nhất chỉ về bệnh nhân đó. Từ nhận định này, nhóm tác giả của hệ thống I đã thêm vào đặc trưng lớp Patient (Patient-class) cho cặp hai khái niệm lớp Person, nó mang giá trị 1 khi hai khái niệm đều chỉ về bệnh nhân và 0  trong các trường hợp khác. Ở bước huấn luyện, thông tin "một khái niệm Person có chỉ về bệnh nhân hay không" được lấy từ tập chuỗi kết quả (ground truth), còn ở bước phân giải đồng tham chiếu thông tin này được xác định nhờ một model phân loại đã được huấn luyện.

Như vậy mục đích của quy trình huấn luyện là xây dựng tổng cộng 6 SVM model, trong đó 4 SVM model nhằm mục đích phân loại và đánh giá độ tin cậy đồng tham chiếu của các cặp khái niệm Person-Person, Problem-Problem, Test-Test và Treatment-Treatment; 1 SVM model để xác định các khái niệm Person có là bệnh nhân hay không (Patient-class) và 1 SVM model để phân loại các đại từ (các khái niệm lớp Pronoun) vào một trong bốn lớp Person, Problem, Test và Treatment. Đầu vào của quy trình này là toàn bộ các văn bản BAĐT với các khái niệm đã được trích xuất và gán nhãn. Sau khi tiền xử lý, hệ thống xây dựng các mẫu huấn luyện
bao gồm: Person, Person-Person, Problem-Problem, Test-Test, Treatment-Treatment và Pronoun từ danh sách các khái niệm. Sáu tập mẫu này được trích xuất thuộc tính và đưa vào để huấn luyện 6 SVM model (Hình \ref{fig:SDHL}). Thư viện SVM được nhóm sử dụng là LibSVM. 

\begin{figure}[th]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.5cm and 2.3cm,
	every join/.style={->, draw},
	font=\tiny\sffamily]

	\node[multidoc](emr){EMR};
	\node[multidoc, right=of emr](con){Concepts};
	\node[proc,below=1.3cm of $(emr)!0.5!(con)$](prep){Tiền xử lý};
	\node[io,join]{Các khái niệm/cặp khái niệm};
	\node[proc,join](ex){Rút trích đặc trưng};
	\node[io, right=3cm of con](perp){Đặc trưng cặp Person};
	\node[io](pati){Đặc trưng một Person};
	\node[io](prop){Đặc trưng cặp Problem};
	\node[io](tstp){Đặc trưng cặp Test};
	\node[io](trep){Đặc trưng cặp Treatment};
	\node[io](pron){Đặc trưng một Pronoun};	
	\node[proc, right=3cm of $(prop)!0.5!(tstp)$](train){Huấn luyện};
	\node[io,right=7cm of perp](perm){SVM model cặp Person};
	\node[io](patim){SVM model cho Patient-class};
	\node[io](prom){SVM model cho cặp Problem};
	\node[io](tstm){SVM model cho cặp Test};
	\node[io](trem){SVM model cho cặp Treatment};
	\node[io](pronm){SVM model cho Pronoun};

	\draw[->] (emr) -- ++(down:0.9cm) -| (prep.130);
	\draw[->] (con) -- ++(down:0.9cm) -| (prep.50);
	\draw[->] (ex) -- ++(right:2.2cm) |- (perp);
	\draw[->] (ex) -- ++(right:2.2cm) |- (pati);
	\draw[->] (ex) -- ++(right:2.2cm) |- (prop);
	\draw[->] (ex) -- ++(right:2.2cm) |- (tstp);
	\draw[->] (ex) -- ++(right:2.2cm) |- (trep);
	\draw[->] (ex) -- ++(right:2.2cm) |- (pron);
	\draw[->] (perp) -- ++(right:2cm) |- (train);
	\draw[->] (pati) -- ++(right:2cm) |- (train);
	\draw[->] (prop) -- ++(right:2cm) |- (train);
	\draw[->] (tstp) -- ++(right:2cm) |- (train);
	\draw[->] (trep) -- ++(right:2cm) |- (train);
	\draw[->] (pron) -- ++(right:2cm) |- (train);
	\draw[->] (train) -- ++(right:1.5cm) |- (perm);
	\draw[->] (train) -- ++(right:1.5cm) |- (patim);
	\draw[->] (train) -- ++(right:1.5cm) |- (prom);
	\draw[->] (train) -- ++(right:1.5cm) |- (tstm);
	\draw[->] (train) -- ++(right:1.5cm) |- (trem);
	\draw[->] (train) -- ++(right:1.5cm) |- (pronm);	
\end{tikzpicture}
\caption{Sơ đồ huấn luyện\label{fig:SDHL}}
\end{figure}

\subsection*{Quy trình phân giải}
Quy trình phân giải đồng tham chiếu sử dụng 6 SVM model đã được huấn luyện ở trên, cùng với đó là một giải thuật gom nhóm các cặp khái niệm đã được phân loại là đồng tham chiếu với nhau lại để cuối cùng tạo thành các chuỗi đồng tham chiếu. Có thể xem đây là quy trình mang đi ứng dụng thực tế để phân giải cho những văn bản BAĐT mới. Dựa vào hệ thống I, chúng tôi sử dụng giải thuật gom cụm tốt nhất trước để lựa chọn các cặp đồng tham chiếu có độ tin cậy cao nhất, sau đó xây dựng các chuỗi đồng tham chiếu bằng cách nối các cặp có một khái niệm chung. Đối với lớp Pronoun, sau khi đã xác định được lớp chính của một đại từ bất kì, chúng tôi tạo một cặp đồng tham chiếu giữa đại từ đó và khái niệm thuộc lớp chính tương ứng ở gần nhất trước đó trong văn bản. Theo nhận định của các tác giả hệ thống I, tuy cách làm này đơn giản nhưng lại tỏ ra rất hiệu quả.

Hình \ref{fig:SDPG} mô tả trực quan quy trình phân giải đồng tham chiếu. Ở bước trích xuất thuộc tính của các cặp Person, chúng tôi sử dụng model phân loại bệnh nhân để xác định giá trị cho đặc trưng lớp Patient đã được đề cập ở trên. Theo kết quả đánh giá các hệ thống dự thi thử thách i2b2 2011, ba hệ đo được sử dụng là: MUC, B-CUBED và CEAF. Chúng tôi cũng hiện thực các hệ đo này để đánh giá hệ thống của mình bằng cách so sánh với kết quả của hệ thống I.

\begin{figure}[th]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.5cm and 2.5cm,
	every join/.style={->, draw},
	font=\tiny\sffamily]

	\node[doc](emr){EMR};
	\node[doc, right=of emr](con){Concepts};
	\node[proc, below=1.3cm of $(emr)!0.5!(con)$](prep){Tiền xử lý};
	\node[io,join](ins){Các khái niệm/cặp khái niệm};
	\node[proc,join](ex){Rút trích đặc trưng};
	\node[io, right=of ex, join](feat){Tập vector đặc trưng};
	\node[proc, right=of feat, join](clas){Phân loại};
	\node[multidoc, above=of clas](model){6 SVM model};
	\node[io,below=of clas](conf){Độ tin cậy đồng tham chiếu};
	\node[proc,join,below=of ex](clus){Gom cụm};
	\node[io,join](sysc){Các chuỗi đồng tham chiếu};
	\node[proc,join,right=of sysc](eval){Đánh giá hiệu năng};
	\node[doc,right=of eval, text width=1.5cm](gt){Các chuỗi đồng tham chiếu kết quả (ground truth)};
	\node[io,below=of eval](res){Các số liệu độ đo};

	\draw[->] (emr) -- ++(down:0.9cm) -| (prep.130);
	\draw[->] (con) -- ++(down:0.9cm) -| (prep.50);
	\draw[->] (model) -> (clas);
	\draw[->] (clas) -> (conf);
	\draw[->] (ins) -- ++(left:1.5cm) |- (clus);
	\draw[->] (gt) -> (eval);
	\draw[->] (eval) -> (res);
	\draw[->] (model.200) -- ++(left:3cm) node[midway,above,sloped]{Model Patient-class} -> (ex.north east);
\end{tikzpicture}
\caption{Sơ đồ phân giải đồng tham chiếu\label{fig:SDPG}}
\end{figure}

\section{Tiền xử lý}
Trong quá trình rút trích đặc trưng, một số khái niệm được miêu tả cụ thể làm cho việc so trùng chuỗi hoặc tìm kiếm từ các nguồn tri thức nhân loại thiếu chính xác \cite{YanXu2012}. Ví dụ như khái niệm "her CT scan" và khái niệm "a CT scan". Mặc dù hai khái niệm này cùng chỉ một thủ tục y tế nhưng không trùng chuỗi. Ngoài ra các mạo từ "her", "a" làm việc tìm kiếm tri thức nhân loại từ các nguồn tri thức như Wikipedia, WordNet không được chính xác hoặc không thể tìm được kết quả. Vì vậy trước khi rút trích đặc trưng, các khái niệm được tiền xử lý để loại bỏ mạo từ và các thông tin ngữ cảnh. Tuy nhiên, quá trình tiền xử lý chỉ được áp dụng cho các đặc trưng liên quan so trùng chuỗi và tìm kiếm tri thức nhân loại, các đặc trưng khác không cần qua quá trình tiền xử lý mà nhận vào nguyên gốc khái niệm được xác định.

Quá trình tiền xử lý gồm hai bước. Đầu tiên khái niệm sẽ được loại bỏ tất cả mạo từ. Sau đó, nếu khái niệm có bao gồm giới từ thì giới từ đó và toàn bộ nội dung theo sau sẽ được lược bỏ. Ví dụ như khái niệm “an MRI of the knee” sau quá trình tiền xử lý sẽ trở thành “MRI”. Danh sách mạo từ được xây dựng từ tập dữ liệu và các mạo từ thông dụng của tiếng Anh.

Đặc biệt các khái niệm thuộc lớp Problem/Treatment/Test thường được kèm thêm thông tin về định lượng như 10mg, 5 lit và các thông tin về vị trí giải phẫu học như "upper", "left", "right". Để tăng khả năng tìm kiếm tri thức nhân loại, chúng tôi đề xuất loại bỏ các thông tin ngữ cảnh về số, định lượng và vị trí giải phẫu khỏi khái niệm. Các thông tin ngữ cảnh được loại bỏ bằng cách sử dụng biểu thức chính quy và các từ vựng được xây dựng từ tập dữ liệu. Các đặc trưng liên quan so trùng chuỗi không áp dụng bước tiền xử lý loại bỏ thông tin ngữ cảnh này.
\section{Xây dựng các cặp khái niệm}
\section{Rút trích đặc trưng}
Từ các phân tích được đề cập ở phần \ref{ytuonghienthuc}, ngoài các thuộc tính chung về mặt ngôn ngữ (như ngữ pháp hay từ vựng), từng lớp khái niệm ở BAĐT còn mang những đặc tính khác nhau. Việc này đòi hỏi chúng tôi phải thiết kế bốn hệ thống rút trích đặc trưng và phân loại tương ứng khác nhau cho lớp Person, lớp Patient, nhóm lớp Problem/Treatment/Test và lớp Pronoun. Hình \ref{fig:TongquanPhangiai} mô tả tổng quan ba hệ thống này, trong đó các khối "Đồng tham chiếu lớp X" bao hàm cả Hệ thống rút trích đặc trưng và Hệ thống phân loại cho lớp tương ứng. Đối với các lớp Person và nhóm lớp Problem/Treatment/Test đầu vào của hệ thống rút trích đặc trưng là một cặp gồm hai khái niệm thuộc các lớp tương ứng, tuy nhiên đối với lớp Pronoun và lớp Patient thì đầu vào là duy nhất một khái niệm thuộc lớp tương ứng.

\begin{figure}[ht]
\centering
\begin{tikzpicture}[%
	>=angle 60,
	start chain=going below,
	node distance=1.5cm and 4cm,
	every join/.style={->, draw},
	font=\tiny\sffamily]
	\tikzset{
		wproc/.style = {proc, text width=4.5em},
		wdoc/.style = {doc, text width=3.5em}
	};
	
	\node[io](pati){Các khái niệm Person};
	\node[io](perp){Các cặp khái niệm Person};
	\node[io](prop){Các cặp khái niệm Problem};
	\node[io](tstp){Các cặp khái niệm Test};
	\node[io](trep){Các cặp khái niệm Treatment};
	\node[io](pron){Các khái niệm Pronoun};
	
	\node[wdoc,left=2cm of $(prop)!0.5!(tstp)$](emr){EMR + Concepts};
	\node[altproc,right=2.5cm of pati](patic){Phân loại bệnh nhân};
	\node[wproc,right=4cm of perp](perr){Phân giải đồng tham chiếu lớp Person};
	\node[wproc](pror){Phân giải đồng tham chiếu lớp Problem};
	\node[wproc](tstr){Phân giải đồng tham chiếu lớp Test};
	\node[wproc](trer){Phân giải đồng tham chiếu lớp Treatment};
	\node[wproc](pronr){Phân giải đồng tham chiếu lớp Pronoun};

	\node[io,right=6cm of perr](perch){Các chuỗi Person};
	\node[io](proch){Các chuỗi Problem};
	\node[io](tstch){Các chuỗi Test};
	\node[io](trech){Các chuỗi Treatment};
	
	\coordinate[left=0.5cm of perch.west](perch-left);
	\coordinate[left=1cm of proch.west](proch-left);
	\coordinate[left=1.5cm of tstch.west](tstch-left);
	\coordinate[left=2cm of trech.west](trech-left);
	
	\draw[->] (emr) -- ++(right:1.3cm) |- (pati);
	\draw[->] (emr) -- ++(right:1.3cm) |- (perp);
	\draw[->] (emr) -- ++(right:1.3cm) |- (prop);
	\draw[->] (emr) -- ++(right:1.3cm) |- (tstp);
	\draw[->] (emr) -- ++(right:1.3cm) |- (trep);
	\draw[->] (emr) -- ++(right:1.3cm) |- (pron);
	\draw[->] (pati) -> (patic);
	\draw[->] (patic) -| (perr);
	\draw[->] (perp) -> (perr);
	\draw[->] (prop) -> (pror);
	\draw[->] (tstp) -> (tstr);
	\draw[->] (trep) -> (trer);
	\draw[->] (pron) -> (pronr);
	\draw[->] (perr) -> (perch);
	\draw[->] (pror) -> (proch);
	\draw[->] (tstr) -> (tstch);
	\draw[->] (trer) -> (trech);
	\draw[->] (pronr) -| (perch-left);
	\draw[->] (pronr) -| (proch-left);
	\draw[->] (pronr) -| (tstch-left);
	\draw[->] (pronr) -| (trech-left);
\end{tikzpicture}
\caption{Tổng quan hệ thống phân giải đồng tham chiếu \label{fig:TongquanPhangiai}}
\end{figure}

\subsection*{Nhóm Person}
Như đã đề cập trong phần \ref{ytuonghienthuc}, trong BAĐT, các khái niệm thuộc lớp Person thường được chia vào ba nhóm chính: bệnh nhân, người thân của bệnh nhân hoặc nhân sự của bệnh viện. Trong đó bệnh nhân là nhóm có số lượng khái niệm được đề cập nhiều nhất và chiếm phần lớn tổng số khái niệm lớp Person. Do vậy việc xác định một khái niệm thuộc vào nhóm nào đóng vai trò quan trọng trong việc phân giải chính xác chuỗi đồng tham chiếu cho khái niệm đó \cite{YanXu2012}. Đặc trưng lớp Patient được xác định bằng phương pháp phân loại nhị phân SVM. Hai nhóm người thân của bệnh nhân và nhân sự của bệnh viện được xác định bằng các đặc trưng từ vựng. Bảng \ref{tab:PersonFeatures} trình bày đầy đủ các đặc trưng dùng cho lớp Person.

\begin{table}[th]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Person \label{tab:PersonFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}P{\raggedright}{0.3}lL@{}}
\toprule 
\textbf{Đặc Trưng} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
Patient-class & 0, 1, 2 & Không có khái niệm nào là bệnh nhân (0), cả hai khái niệm đều là bệnh nhân (1), trường hợp khác (2)\\
Distance between sentences & 0, 1, 2, 3, ... & Số câu xuất hiện giữa hai khái niệm được xét\\
Distance between mentions & 0, 1, 2, 3, ... & Số khái niệm xuất hiện giữa hai khái niệm được xét\\
String match & 0, 1 & Trùng chuỗi hoàn toàn (1), ngược lại (0)\\
Levenshtein distance between two mentions & 0, 1, 2, 3, ... & Khoảng cách Levenshtein giữa hai khái niệm\\
Number & 0, 1, 2 & Cả hai đều là số ít hoặc nhiều (1), ngược lại (0), không xác định (2)\\
Gender & 0, 1, 2 & Cùng giới tính (1), khác giới tính (0), không xác định (2)\\
Apposition & 0, 1 & Là đồng vị ngữ (1), ngược lại (0)\\
Alias & 0, 1 & Là từ viết tắt hoặc cùng nghĩa (1), ngược lại (0)\\
Who & 0, 1 & Nếu hai khái niệm liền kề nhau và được phân cách bởi dấu ``:''\\
Name match & 0, 1 & Loại bỏ các	``stop word'' (dr, dr., mr, ...), so trùng chuỗi con, trùng (1), không trùng (0)\\
Relative match & 0, 1 & Cả hai đều cùng chỉ đến một thân nhân (1), ngược lại (0)\\
Department match & 0, 1 & Cả hai cùng chỉ đến một lĩnh vực y học (1), ngược lại (0)\\
Doctor title match & 0, 1 & Cả hai có cùng một chức vụ bác sĩ (1), ngược lại (0)\\
Doctor general match & 0, 1 & Cả hai cùng đề cập đến bác sĩ nói chung (1), ngược lại (0)\\
Twin/triplet & 0, 1 & Cả hai đều chỉ về cùng cặp sinh đôi/sinh ba (1), ngược lại (0)\\
We & 0, 1 & Cả hai đều chứa thông tin về ``chúng tôi'' (1), ngược lại (0)\\
You & 0, 1 & Cả hai đều chứa thông tin về ``tôi'' (1), ngược lại (0)\\
I & 0, 1 & Cả hai đều chứa thông tin về ``bạn'' (1), ngược lại (0)\\
Pronoun match & 0, 1 & Cả hai đều là đại từ chỉ người (1), ngược lại (0)\\
\bottomrule
\end{tabularx}
\end{table}

Đặc trưng ``Alias'' được chúng tôi hiện thực theo các bước như sau. Bước một, Loại bỏ các mạo từ hoặc đại từ trong khái niệm. Bước hai, kiểm tra các chữ cái đầu tiên của mỗi từ trong khái niệm có được viết hoa hay không. Nếu có thì ghép các chữ cái đầu tiên của mỗi từ để tạo thành từ viết tắt của khái niệm. Cuối cùng, so sánh hai từ đang xét với từ viết tắt của chính hai từ đó, nếu trùng chuỗi thì xác định đặc trưng ``Alias'' là 1, ngược lại là 0.

Đặc trưng về Giới tính được chúng tôi xác định dựa trên ba bước phân loại \cite{WeeSoon2001}. Bước thứ nhất: kiểm tra khái niệm có chứa các đại từ xác định giới tính như ``Mr'', ``Ms'', ``she'', ``he'', ... hay không. Nếu có, xác định giới tính dựa trên đại từ xuất hiện. Nếu không thực hiện bước thứ hai: kiểm tra khái niệm có xuất hiện nhiều hơn một lần hay không. Nếu xuất hiện nhiều hơn một lần thì các lần xuất hiện có chứa đại từ xác định giới tính hay không. Ví dụ khái niệm ``Peter H. Diller'' có thể xuất hiện nhiều lần, trong đó có xuất hiện dưới hình thức ``Mr. Diller''. Nếu không thể xác định giới tính qua hai bước kiểm tra, khái niệm sẽ được phân loại bằng cách sử dụng cơ sở dữ liệu về tên tiếng Anh của hệ thống Apache OpenNLP.

Với các đặc trưng ``Name match'', ``Relative match'', ``Department match'', ``Doctor title match'', ``Doctor general match'', ``Twin/Triplet'', ``We'', ``You'', ``I'', ``Pronoun match'', chúng tôi hiện thực bằng cách xây dựng tập từ điển tương ứng với từng đặc trưng dựa trên việc khảo sát tập dữ liệu và sử dụng các biểu thức chính quy. Các đặc trưng còn lại, chúng tôi hiện thực như miêu tả trong bảng \ref{tab:PersonFeatures}.

\subsection*{Nhóm Patient-class}
Từ nhận định trong việc rút trích đặc trưng của lớp Person, chúng tôi xây dựng một hệ thống SVM nhị phân để phân loại khái niệm thuộc lớp Person có phải là bệnh nhân hay không. Trong BAĐT thường chỉ có một bệnh nhân đóng vai trò là chủ thể của bệnh án.Vì vậy, các khái niệm nếu được xác định là bệnh nhân, thì sẽ được đưa vào một chuỗi đồng tham chiếu duy nhất về bệnh nhân đó. Thông qua phân tích tập dữ liệu, chúng tôi nhận thấy việc xác định một khái niệm thuộc lớp Person hay không có thể đạt được bằng cách xác định tập từ khóa chỉ về bệnh nhân như ``patient'', ``pt'', ... và tập từ khóa chỉ về nhóm người không phải bệnh nhân như ``doctor'', ``dr'', ``wife'', ...

Vì tập dữ liệu không có thông tin xác định một khái niệm thuộc lớp Person có phải là bệnh nhân hay không, dựa theo hệ thống I chúng tôi xác định bằng cách chọn chuỗi đồng tham chiếu có nhiều khái niệm nhất trong tập kết quả làm chuỗi đồng tham chiếu chỉ bệnh nhân. Các khái niệm thuộc chuỗi đồng tham chiếu này sẽ được xem là khái niệm chỉ bệnh nhân và được chọn làm mẫu dương trong quá trình huấn luyện. Các khái niệm thuộc lớp Person còn lại không thuộc vào chuỗi đồng tham chiếu này sẽ được chọn làm mẫu âm trong quá trình huấn luyện. Tuy nhiên, chúng tôi nhận thấy phương pháp xác định bệnh nhân này có một nhược điểm là các BAĐT nhỏ, có nội dung ngắn sẽ tồn tại nhiều chuỗi đồng tham chiếu lớp Person có kích thước tương tự nhau. Trong đó chuỗi đồng tham chiếu chỉ bệnh nhân không chắc chắn là chuỗi đồng tham chiếu có kích thước lớn nhất.

Bảng \ref{tab:PatientFeatures} trình bày đầy đủ các đặc trưng được sử dụng cho việc xác định khái niệm có phải là bệnh nhân hay không. Kết quả của việc phân loại này sẽ được sử dụng làm giá trị cho đặc trưng ``Patient-class'' khi rút trích đặc trưng cho lớp Person.

\begin{table}[th]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Patient \label{tab:PatientFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}P{\raggedright}{0.3}lL@{}}
\toprule 
\textbf{Đặc Trưng} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
Keyword of patient & 0, 1 & Các từ khóa về bệnh nhân (như mr., mr, ms., ms, yo-, y.o., y/o, year-old, ...)\\
Keyword of doctor & 0, 1 & Các từ khóa về bác sĩ (dr, dr., md, m.d., m.d,…)\\
Key word of doctor title & 0, 1 & Các từ khóa về chức vụ của bác sĩ (dentist, orthodontist, …)\\
Key word of department  & 0, 1 & Các từ khóa về chuyên ngành bác sĩ (electrophysiology, …)\\
Key word of general deparment & 0, 1 & Các từ khóa chung về phòng ban (team, service)\\
Key word of general doctor & 0, 1 & Các từ khóa chung về bác sĩ (doctor, dict, author, pcp, attend, provider)\\
Key word of relative & 0, 1 & Các từ khóa về người thân (wife, brother, sibling, nephew)\\
Name & 0, 1 & Có phải là tên riêng hay không\\
Last n line doctor & 0, 1 & Là tên bác sĩ ở n dòng cuối cùng\\
Twin or triplet information & 0, 1 & Thông tin về cặp sinh đôi, sinh ba (baby 1, 2, 3,…)\\
Preceded by non-patient & 0, 1 & Khái niệm đứng trước không phải là bệnh nhân.\\
Signed information  & 0, 1 & Có liên quan đến việc kí/xác nhận bệnh án\\
Previous sentence &  & Câu hoàn chỉnh liền trước khái niệm\\
Next sentence &  & Câu hoàn chỉnh liền sau khái niệm\\
Pronouns we & 0, 1 & Là đại từ chỉ chúng tôi (we, us, our, ourselves)\\
Pronouns I & 0, 1 & Là đại từ chỉ tôi (I, my, me, myself)\\
Pronouns you & 0, 1 & Là đại từ chỉ bạn (you, your, yourself)\\
Pronouns they & 0, 1 & Là đại từ chỉ họ (they, them, their, themselves)\\
Pronouns he/she most & 0, 1 & Thuộc phần đa số của đại từ chỉ cô ấy/anh ấy (he, his, her)\\
Who & 0, 1 & Là đại từ “who” hoặc liền kề với khái niệm đứng trước\\
Appositive & 0, 1 & Là đồng vị ngữ\\
\bottomrule
\end{tabularx}
\end{table}

Các đặc trưng ``Previous sentence'' và ``Next sentence'' được hiện thực bằng cách khảo sát toàn bộ các khái niệm thuộc lớp Person, sau đó xây dựng bộ từ điển các câu có thể đứng trước hoặc đứng sau khái niệm đang xét. Giá trị của đặc trưng được lấy bằng chỉ mục của câu đứng trước (hoặc đứng sau) trong bộ từ điển các câu.

Đặc trưng ``Pronouns he/she most'' mang ý nghĩa giới tính chiếm đa số trong BAĐT được xét. Việc xác định giới tính chiếm đa số trong BAĐT được hiện thực bằng cách xác định giới tính cho từng khái niệm thuộc lớp Person, sau đó chọn giới tính có số lượng khái niệm lớn hơn. Phương pháp xác định giới tính được thực hiện theo miêu tả trong đặc trưng của nhóm Person. Nếu trong BAĐT có giới tính Nam chiếm đa số thì những khái niệm là đại từ chỉ về giới tính Nam như ``he'', ``him'', ``himself'', ... sẽ có đặc trưng ``Pronouns he/she most'' mang giá trị là 1. Tương tự cho BAĐT có giới tính Nữ chiếm đa số.

Qua việc khảo sát tập dữ liệu, chúng tôi nhận thấy trong BAĐT thường được kết thúc bằng các thông tin hướng dẫn liên lạc với bác sĩ nếu bệnh nhân gặp vấn đề sau khi xuất viện, thông tin về ngày tháng và mã BAĐT, thông tin về hướng dẫn sau khi xuất viện và ký tên của bác sĩ. Để xác định phần BAĐT chứa các thông tin này, chúng tôi khảo sát từng câu trong BAĐT từ dưới lên đến khi gặp các từ khóa như ``Follow-up'', ``Dictated By'', ``Signed By'', ... Các đặc trưng ``Last n line doctor'' và ``Signed information'' được xác định bằng các thông tin trong phân đoạn BAĐT này.

Các đặc trưng liên quan đến từ khóa được chúng tôi hiện thực bằng cách khảo sát tập dữ liệu và xây dựng bộ từ điển thích hợp cho từng đặc trưng. Các đặc trưng còn lại được chúng tôi hiện thực theo như miêu tả trong bảng \ref{tab:PatientFeatures}

\subsection*{Nhóm Pronoun}
Khác với các lớp khái niệm khác trong BAĐT, lớp khái niệm Pronoun là lớp khái niệm trừu tượng, có thể chỉ về bất kì khái niệm thuộc bốn lớp Person, Problem, Treatment, Test hoặc là khái niệm độc lập không đồng tham chiếu. Để giải quyết vấn đề đồng tham chiếu cho lớp Pronoun, tác giả của hệ thống I đề xuất xây dựng hệ thống phân loại SVM nhiều lớp (multi-class SVM). Hệ thống SVM này dùng để phân loại khái niệm thuộc lớp Pronoun đang xét đồng tham chiếu đến lớp khái niệm nào trong bốn lớp Person, Problem, Treatment, Test. Sau đó ta chọn khái niệm thuộc lớp tương ứng ở gần nhất trước đó để làm tiền đề cho đại từ đang xét. Ví dụ ``\underline{Hepatitis C cirrhosis} for \textit{which} the patient was on the liver transplant list'' có ``which'' là đại từ đang xét và ``Hepatitis C cirrhosis'' là khái niệm thuộc lớp Problem. Nếu xác định được đại từ ``which'' thuộc lớp Problem, ta có thể kết luận ``which'' và ``Hepatitis C cirrhosis'' đồng tham chiếu do khái niệm ``Hepatitis C cirrhosis'' cùng thuộc lớp Problem và ở gần nhất trước đó. Bảng \ref{tab:PronounFeatures} mô tả đầy đủ các đặc trưng được sử dụng cho lớp Pronoun.

\begin{table}[th]
\centering\ra{1.2}
\caption{Tập đặc trưng cho lớp Pronoun \label{tab:PronounFeatures}}
\footnotesize\sffamily

\begin{tabularx}{\textwidth}{@{}P{\raggedright}{0.3}lL@{}}
\toprule 
\textbf{Đặc Trưng} & \textbf{Giá trị} & \textbf{Giải thích}\\
\midrule
First previous mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền trước thuộc lớp Person (0), hoặc Problem (1), hoặc Treatment (2), hoặc Test (3) hoặc không thuộc lớp nào (4)\\
Second previous mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền trước thứ 2 thuộc lớp Person (0), hoặc Problem (1), hoặc Treatment (2), hoặc Test (3) hoặc không thuộc lớp nào (4)\\
First next mention type & 0, 1, 2, 3, 4 & Khái niệm đứng liền sau thuộc lớp Person (0), hoặc Problem (1), hoặc Treatment (2), hoặc Test (3) hoặc không thuộc lớp nào (4)\\
Sentence distance & 0, 1, 2, ... & Số câu xuất hiện giữa hai khái niệm được xét\\
Pronoun & 0, 1, 2, ..., 14 & Chỉ mục của đại từ được xét trong bảng tra 15 đại từ\\
Part of speech & 0, 1, 2 & DT (0), WDT (1), PRP (2)\\
First next verb after mention & & Động từ đứng liền sau khái niệm\\
First word before mention is preposition & 0, 1 & Từ liền trước là giới từ (1), ngược lại (0)\\
First one/two/three words before mention & & 1/2/3 từ liền trước khái niệm được xét\\
First one/two/three words after mention & & 1/2/3 từ liền sau khái niệm được xét\\
An adjacent mention after pronoun + VP  & 0, 1 & Khái niệm được xét liền sau đại từ + cụm động từ\\
And, as well as, in addition to & 0, 1 & Khái niệm được xét liền sau ``and'', ``as well as'', ``in addition to''\\
\bottomrule
\end{tabularx}
\end{table}

Các đặc trưng ``First next verb after mention'', ``First one/two/three words before mention'', ``First one/two/three words after mention'' được hiện thực bằng cách khảo sát toàn bộ các khái niệm thuộc lớp Pronoun, sau đó xây dựng bộ từ điển các từ có thể đứng trước hoặc đứng sau khái niệm đang xét. Giá trị của đặc trưng được lấy bằng chỉ mục của từ đứng trước (hoặc đứng sau) trong bộ từ điển các từ.

Các đặc trưng ``Part of speech'', ``First word after mention is preposition'', ``An adjacent mention after pronoun + VP'' được hiện thực bằng cách tìm câu văn chứa khái niệm đang xét trong BAĐT. Sau đó, chúng tôi tiến hành phân đoạn câu (tokenize) và đánh dấu thông tin từ loại (POS tag)\cite{treebank} đối với câu văn chứa khái niệm đang xét. Từ danh sách thông tin từ loại có được, các đặc trưng nêu trên được tính giá trị theo mô tả. Chúng tôi sử dụng hệ thống xử lý ngôn ngữ tự nhiên Apache OpenNLP cho các tác vụ phân đoạn câu và đánh dấu thông tin từ loại. Các đặc trưng còn lại được chúng tôi hiện thực theo như mô tả trong bảng \ref{tab:PronounFeatures}.

\subsection*{Nhóm Problem/Treatment/Test}
Nhóm lớp Problem/Treatment/Test là nhóm lớp đặc biệt thuộc riêng lĩnh vực y khoa. Trong lĩnh vực này, cùng một khái niệm có thể được biểu diễn dưới nhiều hình thức khác nhau. Ví dụ để chỉ nồng độ bạch cầu trong máu, trong BAĐT có thể được diễn đạt là ``WBC'', ``white blood cell count'' hoặc ``white blood count''. Việc xác định được các cụm từ có cách diễn đạt khác nhau nhưng cùng chỉ một khái niệm có thể giúp tăng độ chính xác và giải sai sót trong quá trình phân loại. Để làm được điều này, tác giả của hệ thống I đề xuất sử dụng các nguồn tri thức nhân loại bên ngoài như Wikipedia, UMLS hoặc WordNet.

Mặt khác, đối với lớp Problem/Test/Treatment, cùng một sự kiện y khoa có thể xảy ra nhiều lần nhưng các sự kiện y khoa đó có thể không đồng tham chiếu mà mang nhiều ý nghĩa khác nhau. Nguyên nhân vì trong các sự kiện y khoa thường bị ảnh hưởng bởi ngữ cảnh mà chúng được đề cập đến. Ví dụ ``the right \textit{leg}'' và ``the left \textit{leg}'', khái niệm được đề cập đều là ``leg'' tuy nhiên ngữ cảnh trong văn bản cho thấy đó là hai khái niệm chỉ hai chân khác nhau. Vì vậy để xây dựng chính xác chuỗi đồng tham chiếu của nhóm lớp Problem/Treatment/Test, dựa theo hệ thống I, cần phải có một hệ thống trích xuất thông tin ngữ cảnh trong văn bản.

\textbf{Các nguồn tri thức nhân loại}

\emph{Wikipedia}\\
Wikipedia là hệ thống bách khoa toàn thư miễn phí đa ngôn ngữ, nền Web dựa trên mô hình cho phép người dùng chỉnh sửa nội dung \cite{wikipediaabout}. Các tri thức nhân loại từ Wikipedia có thể được sử dụng để xác định tên giả (alias), tên viết tắt hoặc các từ đồng nghĩa hay có liên quan với nhau. Ví dụ hai khái niệm ``head trauma'' và ``head injury'' có thể được xác định là đồng nghĩa dựa trên thông tin từ Wikipedia.

Dựa trên thiết kế của hệ thống I, chúng tôi xây dựng bộ trích xuất các thông tin về tiêu đề bài viết (title hoặc redirected link), từ in đậm (bold name) trong bài viết và các khái niệm liên quan (anchor link) được đề cập trong bài viết. Ngôn ngữ của Wikipeda được chúng tôi sử dụng là tiếng Anh . Để trích xuất được các thông tin này, chúng tôi sử dụng công cụ Wikipedia-miner được đề cập trong phần \ref{tools}. Do số lượng khái niệm cần được rút trích thông tin từ Wikipedia rất lớn, vì vậy để cải thiện hiệu năng thời gian của hệ thống, chúng tôi đề xuất trước khi thực hiện rút trích đặc trưng của nhóm lớp Problem/Treatment/Test, các khái niệm thuộc nhóm lớp này cần được rút trích riêng thông tin từ Wikipedia và ghi xuống file lưu trữ.

\emph{UMLS}\\
Trong quá trình phát triển của y học, nhu cầu có một bộ từ điển chung, chứa các thông tin đã được chuẩn hóa về các loại bệnh, thuốc, nguyên nhân hoặc các thuật ngữ trong y tế ngày càng cao. Vì lí do đó, bộ từ điển UMLS - Unified Medical Language System đã được Mỹ tiến hành xây dựng từ năm 1986 bởi Thư viện Y học Quốc gia Hoa Kì (US National Library of Medicine) \cite{umlswiki}.

Trong mô tả của hệ thống I, một số đặc trưng về ngữ nghĩa trong văn bản cần khai thác thông tin từ bộ từ điển UMLS. Cụ thể bộ trích xuất ngữ nghĩa trong văn bản cần xác định một khái niệm có xuất hiện trong bộ từ điển UMLS hay không, nếu có thì khái niệm đó thuộc phân nhóm nào trong từ điển UMLS. Ví dụ như khái niệm ``lung cancer'' xuất hiện trong từ điển UMLS dưới phân nhóm Các tiến trình liên quan u, bướu (Neoplastic Process). Để trích xuất các thông tin này, chúng tôi sử dụng công cụ Metamap được đề cập trong phần \ref{tools}. Tương tự như việc rút trích thông tin từ Wikipedia, chúng tôi đề xuất các khái niệm cần được rút trích thông tin từ UMLS và ghi xuống file lưu trữ trước khi tiến hành rút trích đặc trưng cho nhóm lớp Problem/Treatment/Test.

\emph{WordNet}\\
WordNet là bộ từ điển được xây dựng tiếng Anh bao gồm các từ vựng đã được phân loại vai trò ngữ pháp như danh từ, tính từ, trạng từ, động từ. Các từ xuất hiện trong WordNet đã được nhóm lại với nhau thành các nhóm từ có cùng ý nghĩa. WordNet có vai trò giống như Wikipedia trong việc xác định tên giả, viết tắt và từ đồng nghĩa.

\textbf{Bộ trích xuất ngữ nghĩa trong văn bản}

\emph{Trích xuất thông tin cơ quan trên cơ thể (Anatomy)}\\

\emph{Trích xuất thông tin vị trí (Position)}\\

\emph{Trích xuất thông tin thuốc y tế (Medical information)}\\

\emph{Trích xuất thông tin chỉ số của thủ tục y tế (Indicator)}\\

\emph{Trích xuất thông tin thời gian (Temporal)}\\

\emph{Trích xuất thông tin phân đoạn bệnh án (Section)}\\

\emph{Trích xuất thông tin bổ từ (Modifier)}\\

\emph{Trích xuất thông tin thiết bị y tế (Equipment)}\\

\emph{Trích xuất thông tin Phẫu thuật y tế (Operation)}\\

\section{Gom cụm và xây dựng chuỗi đồng tham chiếu}
Ở mô hình cặp thực thể, hệ thống phân loại không có khả năng xây dựng chuỗi đồng tham chiếu mà nó chỉ có thể xác định một cặp khái niệm là có đồng tham chiếu hay không. Mặt khác, đối với một văn bản HSXV, số cặp khái niệm được sinh ra rất nhiều và trong số đó có nhiều cặp có chung khái niệm đứng sau, ví dụ hai cặp “Dr. John”-“his” và “Mr. Brown”-“his” có chung khái niệm đứng sau là “his” mà hai cặp này đều được hệ thống phân loại xác định là đồng tham chiếu, tuy nhiên chỉ một trong hai khái niệm “Dr. John” và “Mr. Brown” được chọn làm tiền đề cho khái niệm “his” này. Như vậy cần thiết phải có một giải thuật lựa chọn các cặp đồng tham chiếu và xây dựng các chuỗi đồng tham chiếu từ chúng.

Như đã được đề cập ở mục, có hai giải thuật được đề xuất là: \emph{gom cụm gần nhất trước} và \emph{gom cụm tốt nhất trước}. Chúng tôi lựa chọn thực hiện giải thuật gom cụm tốt nhất trước cho hệ thống của mình vì hai lý do:
\begin{enumerate}[leftmargin=\the\parindent]
\item Theo [x], giải thuật gom cụm tốt nhất trước cho kết quả tốt hơn giải thuật gom cụm gần nhất trước.
\item Các tác giả hệ thống [I] cũng hiện thực giải thuật này cho hệ thống của họ.
\end{enumerate}

Về cơ bản, giải thuật gom cụm tốt nhất trước lựa chọn các cặp khái niệm được xác định là đồng tham chiếu và có độ tin cậy cao nhất ứng với mỗi hồi chỉ; đối với đại từ, giải thuật sử dụng module phân loại xác định lớp chính của đại từ đó và tạo một cặp đồng tham chiếu giữa nó với khái niệm thuộc lớp tương ứng gần nhất trước đó (theo thứ tự xuất hiện) trong văn bản HSXV. Sau khi có được tập các cặp đồng tham chiếu, giải thuật nối các cặp có một khái niệm chung lại để tạo thành các chuỗi. Đây chính là kết quả cuối cùng của hệ thống phân giải.

Như vậy giải thuật gom cụm cụm tốt nhất trước bao gồm hai bước chính: chọn lọc các cặp đồng tham chiếu tốt nhất và ghép nối các cặp được chọn để tạo thành danh sách các chuỗi đồng tham chiếu. Chi tiết của bước đầu tiên, PAIR-SELECTION, và bước thứ 2, CHAINING, được trình bày ở Giải thuật \ref{alg:pair-selection} và Giải thuật \ref{alg:chaining} tương ứng. Trong đó, PAIR-SELECTION nhận đầu vào là văn bản HSXV $E$, danh sách các khái niệm $C$ của $E$; còn CHAINING nhận đầu vào là danh sách các cặp đồng tham chiếu chọn lọc được xuất ra bởi PAIR-SELECTION và ghép nối các cặp từ danh sách này để xây dựng các chuỗi đồng tham chiếu.

\begin{figure}[th]
\begin{algorithm}[H]
\caption{PAIR-SELECTION\label{alg:pair-selection}}
\SetKwFunction{TypeOf}{TypeOf}
\SetKwFunction{PRONOUN}{PRONOUN}

\Input{văn bản HSXV $E$, danh sách khái niệm $C$}
\Output{danh sách các cặp đồng tham chiếu}
\BlankLine
$M$: số khái niệm trong danh sách $C$\;
$pairs \leftarrow \emptyset$\;
\BlankLine
\For{$i \leftarrow 1$ \KwTo $M$}{
	$ana \leftarrow C[i]$\;	
	\eIf{\TypeOf{$ana$} $\neq$ \PRONOUN}{
		\tcp{tìm khái niệm đứng trước đồng tham chiếu với $ana$ có độ tin cậy cao nhất}
		$bestConf \leftarrow \Null$\;
		$bestAnte \leftarrow \Null$\;
		\For{$j \leftarrow i - 1$ \KwDownTo $0$}{
			$ante \leftarrow C[j]$\;				
			\lIf{$\TypeOf{ante} \neq \TypeOf{ana}$}{\KwContinue}		
			\If{cặp $(ante,ana)$ đồng tham chiếu}{
				$conf\leftarrow$ độ tin cậy đồng tham chiếu của $(ante,ana)$\;
				\If{$bestConf = \Null$ \KwOr $bestConf < conf$}{
					$confidence \leftarrow conf$\;
					$bestAnte \leftarrow ante$\;
				}
			}
		}
		\BlankLine
		\If{$bestConf \neq \Null$ \KwAnd $bestAnte \neq \Null$}{
			thêm cặp $(bestAnte, ana)$ vào $pairs$\;
		}
	}{
		\tcp{xác định lớp chính của đại từ bằng module phân loại}
		$t\leftarrow$ lớp chính của $ana$\;
		\For{$j \leftarrow i - 1$ \KwDownTo 0}{
			\tcp{tìm khái niệm cùng lớp chính với $ana$ gần nhất trước đó}
			$ante \leftarrow C[j]$\;
			\If{$\TypeOf{ante} = t$}{
				thêm cặp $(ante,ana)$ vào $pairs$\;
				\KwBreak\;
			}
		}
	}	
}
\Return{pairs}\;
\end{algorithm}
\end{figure}

\begin{figure}[th]
\begin{algorithm}[H]
\caption{CHAINING\label{alg:chaining}}

\Input{danh sách các cặp đồng tham chiếu $pairs$}
\Output{danh sách các chuỗi đồng tham chiếu}
\BlankLine
$chains$: danh sách các chuỗi đồng tham chiếu\;
$chains\leftarrow\emptyset$\;
\ForEach(\tcp*[h]{với mỗi cặp đồng tham chiếu}){$(ante, ana)$ \KwIn $pairs$}{
	$added\leftarrow\False$\;
	\ForEach{$c$ \KwIn $chains$}{
		\tcp{nếu có một chuỗi $c$ chứa một trong hai khái niệm của cặp}
		\If(\tcp*[h]{đưa cặp vào chuỗi}){$(ante$ \KwIn $c)$ \KwOr $(ana$ \KwIn $c)$}{
			$c\leftarrow c\cup \{ante, ana\}$\;
			$added\leftarrow\True$\;
			\KwBreak;
		}
	}
	\BlankLine
	\tcp{nếu không có chuỗi nào chứa một trong hai khái niệm của cặp}
	\If{$added=\False$}{
		\tcp{tạo một chuỗi mới $c$ gồm hai khái niệm của cặp}
		$c\leftarrow\{ante, ana\}$\;
		thêm $c$ vào $chains$\;
	}
}

\Return{chains}\;
\end{algorithm}
\end{figure}
